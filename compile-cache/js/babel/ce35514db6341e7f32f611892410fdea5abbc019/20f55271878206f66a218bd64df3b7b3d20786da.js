Object.defineProperty(exports, '__esModule', {
  value: true
});
exports.shouldTriggerLinter = shouldTriggerLinter;
exports.getEditorCursorScopes = getEditorCursorScopes;
exports.isPathIgnored = isPathIgnored;
exports.subscriptiveObserve = subscriptiveObserve;
exports.messageKey = messageKey;
exports.normalizeMessages = normalizeMessages;
exports.messageKeyLegacy = messageKeyLegacy;
exports.normalizeMessagesLegacy = normalizeMessagesLegacy;

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { 'default': obj }; }

var _minimatch = require('minimatch');

var _minimatch2 = _interopRequireDefault(_minimatch);

var _lodashUniq = require('lodash.uniq');

var _lodashUniq2 = _interopRequireDefault(_lodashUniq);

var _atom = require('atom');

var $version = '__$sb_linter_version';
exports.$version = $version;
var $activated = '__$sb_linter_activated';
exports.$activated = $activated;
var $requestLatest = '__$sb_linter_request_latest';
exports.$requestLatest = $requestLatest;
var $requestLastReceived = '__$sb_linter_request_last_received';

exports.$requestLastReceived = $requestLastReceived;

function shouldTriggerLinter(linter, wasTriggeredOnChange, scopes) {
  if (wasTriggeredOnChange && !(linter[$version] === 2 ? linter.lintsOnChange : linter.lintOnFly)) {
    return false;
  }
  return scopes.some(function (scope) {
    return linter.grammarScopes.includes(scope);
  });
}

function getEditorCursorScopes(textEditor) {
  return (0, _lodashUniq2['default'])(textEditor.getCursors().reduce(function (scopes, cursor) {
    return scopes.concat(cursor.getScopeDescriptor().getScopesArray());
  }, ['*']));
}

function isPathIgnored(filePath, ignoredGlob, ignoredVCS) {
  if (ignoredVCS) {
    var repository = null;
    var projectPaths = atom.project.getPaths();
    for (var i = 0, _length2 = projectPaths.length; i < _length2; ++i) {
      var projectPath = projectPaths[i];
      if (filePath.indexOf(projectPath) === 0) {
        repository = atom.project.getRepositories()[i];
        break;
      }
    }
    if (repository && repository.isPathIgnored(filePath)) {
      return true;
    }
  }
  var normalizedFilePath = process.platform === 'win32' ? filePath.replace(/\\/g, '/') : filePath;
  return (0, _minimatch2['default'])(normalizedFilePath, ignoredGlob);
}

function subscriptiveObserve(object, eventName, callback) {
  var subscription = null;
  var eventSubscription = object.observe(eventName, function (props) {
    if (subscription) {
      subscription.dispose();
    }
    subscription = callback.call(this, props);
  });

  return new _atom.Disposable(function () {
    eventSubscription.dispose();
    if (subscription) {
      subscription.dispose();
    }
  });
}

function messageKey(message) {
  var reference = message.reference;
  return ['$LINTER:' + message.linterName, '$LOCATION:' + message.location.file + '$' + message.location.position.start.row + '$' + message.location.position.start.column + '$' + message.location.position.end.row + '$' + message.location.position.end.column, reference ? '$REFERENCE:' + reference.file + '$' + (reference.position ? reference.position.row + '$' + reference.position.column : '') : '$REFERENCE:null', '$EXCERPT:' + message.excerpt, '$SEVERITY:' + message.severity, message.icon ? '$ICON:' + message.icon : '$ICON:null', message.url ? '$URL:' + message.url : '$URL:null'].join('');
}

function normalizeMessages(linterName, messages) {
  for (var i = 0, _length3 = messages.length; i < _length3; ++i) {
    var message = messages[i];
    var reference = message.reference;
    if (Array.isArray(message.location.position)) {
      message.location.position = _atom.Range.fromObject(message.location.position);
    }
    if (reference && Array.isArray(reference.position)) {
      reference.position = _atom.Point.fromObject(reference.position);
    }
    if (message.solutions && message.solutions.length) {
      for (var j = 0, _length = message.solutions.length, solution = undefined; j < _length; j++) {
        solution = message.solutions[j];
        if (Array.isArray(solution.position)) {
          solution.position = _atom.Range.fromObject(solution.position);
        }
      }
    }
    message.version = 2;
    if (!message.linterName) {
      message.linterName = linterName;
    }
    message.key = messageKey(message);
  }
}

function messageKeyLegacy(message) {
  return ['$LINTER:' + message.linterName, '$LOCATION:' + (message.filePath || '') + '$' + (message.range ? message.range.start.row + '$' + message.range.start.column + '$' + message.range.end.row + '$' + message.range.end.column : ''), '$TEXT:' + (message.text || ''), '$HTML:' + (message.html || ''), '$SEVERITY:' + message.severity, '$TYPE:' + message.type, '$CLASS:' + (message['class'] || '')].join('');
}

function normalizeMessagesLegacy(linterName, messages) {
  for (var i = 0, _length4 = messages.length; i < _length4; ++i) {
    var message = messages[i];
    var fix = message.fix;
    if (message.range && message.range.constructor.name === 'Array') {
      message.range = _atom.Range.fromObject(message.range);
    }
    if (fix && fix.range.constructor.name === 'Array') {
      fix.range = _atom.Range.fromObject(fix.range);
    }
    if (!message.severity) {
      var type = message.type.toLowerCase();
      if (type === 'warning') {
        message.severity = type;
      } else if (type === 'info' || type === 'trace') {
        message.severity = 'info';
      } else {
        message.severity = 'error';
      }
    }
    message.version = 1;
    message.linterName = linterName;
    message.key = messageKeyLegacy(message);

    if (message.trace) {
      normalizeMessagesLegacy(linterName, message.trace);
    }
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9Vc2Vycy9ldmFuaGVuZHJpeDEvLmF0b20vcGFja2FnZXMvbGludGVyL2xpYi9oZWxwZXJzLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7O3lCQUVzQixXQUFXOzs7OzBCQUNULGFBQWE7Ozs7b0JBQ0ksTUFBTTs7QUFJeEMsSUFBTSxRQUFRLEdBQUcsc0JBQXNCLENBQUE7O0FBQ3ZDLElBQU0sVUFBVSxHQUFHLHdCQUF3QixDQUFBOztBQUMzQyxJQUFNLGNBQWMsR0FBRyw2QkFBNkIsQ0FBQTs7QUFDcEQsSUFBTSxvQkFBb0IsR0FBRyxvQ0FBb0MsQ0FBQTs7OztBQUVqRSxTQUFTLG1CQUFtQixDQUNqQyxNQUFjLEVBQ2Qsb0JBQTZCLEVBQzdCLE1BQXFCLEVBQ1o7QUFDVCxNQUFJLG9CQUFvQixJQUFJLEVBQUUsTUFBTSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsR0FBRyxNQUFNLENBQUMsYUFBYSxHQUFHLE1BQU0sQ0FBQyxTQUFTLENBQUEsQUFBQyxFQUFFO0FBQy9GLFdBQU8sS0FBSyxDQUFBO0dBQ2I7QUFDRCxTQUFPLE1BQU0sQ0FBQyxJQUFJLENBQUMsVUFBUyxLQUFLLEVBQUU7QUFDakMsV0FBTyxNQUFNLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQTtHQUM1QyxDQUFDLENBQUE7Q0FDSDs7QUFFTSxTQUFTLHFCQUFxQixDQUFDLFVBQXNCLEVBQWlCO0FBQzNFLFNBQU8sNkJBQVksVUFBVSxDQUFDLFVBQVUsRUFBRSxDQUFDLE1BQU0sQ0FBQyxVQUFDLE1BQU0sRUFBRSxNQUFNO1dBQy9ELE1BQU0sQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLGtCQUFrQixFQUFFLENBQUMsY0FBYyxFQUFFLENBQUM7R0FDNUQsRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQTtDQUNYOztBQUVNLFNBQVMsYUFBYSxDQUFDLFFBQWdCLEVBQUUsV0FBbUIsRUFBRSxVQUFtQixFQUFXO0FBQ2pH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L0QsYUFBTyxDQUFDLEtBQUssR0FBRyxZQUFNLFVBQVUsQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUE7S0FDaEQ7QUFDRCxRQUFJLEdBQUcsSUFBSSxHQUFHLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQyxJQUFJLEtBQUssT0FBTyxFQUFFO0FBQ2pELFNBQUcsQ0FBQyxLQUFLLEdBQUcsWUFBTSxVQUFVLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFBO0tBQ3hDO0FBQ0QsUUFBSSxDQUFDLE9BQU8sQ0FBQyxRQUFRLEVBQUU7QUFDckIsVUFBTSxJQUFJLEdBQUcsT0FBTyxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQTtBQUN2QyxVQUFJLElBQUksS0FBSyxTQUFTLEVBQUU7QUFDdEIsZUFBTyxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUE7T0FDeEIsTUFBTSxJQUFJLElBQUksS0FBSyxNQUFNLElBQUksSUFBSSxLQUFLLE9BQU8sRUFBRTtBQUM5QyxlQUFPLENBQUMsUUFBUSxHQUFHLE1BQU0sQ0FBQTtPQUMxQixNQUFNO0FBQ0wsZUFBTyxDQUFDLFFBQVEsR0FBRyxPQUFPLENBQUE7T0FDM0I7S0FDRjtBQUNELFdBQU8sQ0FBQyxPQUFPLEdBQUcsQ0FBQyxDQUFBO0FBQ25CLFdBQU8sQ0FBQyxVQUFVLEdBQUcsVUFBVSxDQUFBO0FBQy9CLFdBQU8sQ0FBQyxHQUFHLEdBQUcsZ0JBQWdCLENBQUMsT0FBTyxDQUFDLENBQUE7O0FBRXZDLFFBQUksT0FBTyxDQUFDLEtBQUssRUFBRTtBQUNqQiw2QkFBdUIsQ0FBQyxVQUFVLEVBQUUsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFBO0tBQ25EO0dBQ0Y7Q0FDRiIsImZpbGUiOiIvVXNlcnMvZXZhbmhlbmRyaXgxLy5hdG9tL3BhY2thZ2VzL2xpbnRlci9saWIvaGVscGVycy5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qIEBmbG93ICovXG5cbmltcG9ydCBtaW5pbWF0Y2ggZnJvbSAnbWluaW1hdGNoJ1xuaW1wb3J0IGFycmF5VW5pcXVlIGZyb20gJ2xvZGFzaC51bmlxJ1xuaW1wb3J0IHsgRGlzcG9zYWJsZSwgUmFuZ2UsIFBvaW50IH0gZnJvbSAnYXRvbSdcbmltcG9ydCB0eXBlIHsgVGV4dEVkaXRvciB9IGZyb20gJ2F0b20nXG5pbXBvcnQgdHlwZSB7IExpbnRlciwgTWVzc2FnZSwgTWVzc2FnZUxlZ2FjeSB9IGZyb20gJy4vdHlwZXMnXG5cbmV4cG9ydCBjb25zdCAkdmVyc2lvbiA9ICdfXyRzYl9saW50ZXJfdmVyc2lvbidcbmV4cG9ydCBjb25zdCAkYWN0aXZhdGVkID0gJ19fJHNiX2xpbnRlcl9hY3RpdmF0ZWQnXG5leHBvcnQgY29uc3QgJHJlcXVlc3RMYXRlc3QgPSAnX18kc2JfbGludGVyX3JlcXVlc3RfbGF0ZXN0J1xuZXhwb3J0IGNvbnN0ICRyZXF1ZXN0TGFzdFJlY2VpdmVkID0gJ19fJHNiX2xpbnRlcl9yZXF1ZXN0X2xhc3RfcmVjZWl2ZWQnXG5cbmV4cG9ydCBmdW5jdGlvbiBzaG91bGRUcmlnZ2VyTGludGVyKFxuICBsaW50ZXI6IExpbnRlcixcbiAgd2FzVHJpZ2dlcmVkT25DaGFuZ2U6IGJvb2xlYW4sXG4gIHNjb3BlczogQXJyYXk8c3RyaW5nPixcbik6IGJvb2xlYW4ge1xuICBpZiAod2FzVHJpZ2dlcmVkT25DaGFuZ2UgJiYgIShsaW50ZXJbJHZlcnNpb25dID09PSAyID8gbGludGVyLmxpbnRzT25DaGFuZ2UgOiBsaW50ZXIubGludE9uRmx5KSkge1xuICAgIHJldHVybiBmYWxzZVxuICB9XG4gIHJldHVybiBzY29wZXMuc29tZShmdW5jdGlvbihzY29wZSkge1xuICAgIHJldHVybiBsaW50ZXIuZ3JhbW1hclNjb3Blcy5pbmNsdWRlcyhzY29wZSlcbiAgfSlcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldEVkaXRvckN1cnNvclNjb3Blcyh0ZXh0RWRpdG9yOiBUZXh0RWRpdG9yKTogQXJyYXk8c3RyaW5nPiB7XG4gIHJldHVybiBhcnJheVVuaXF1ZSh0ZXh0RWRpdG9yLmdldEN1cnNvcnMoKS5yZWR1Y2UoKHNjb3BlcywgY3Vyc29yKSA9PiAoXG4gICAgc2NvcGVzLmNvbmNhdChjdXJzb3IuZ2V0U2NvcGVEZXNjcmlwdG9yKCkuZ2V0U2NvcGVzQXJyYXkoKSlcbiAgKSwgWycqJ10pKVxufVxuXG5leHBvcnQgZnVuY3Rpb24gaXNQYXRoSWdub3JlZChmaWxlUGF0aDogc3RyaW5nLCBpZ25vcmVkR2xvYjogc3RyaW5nLCBpZ25vcmVkVkNTOiBib29sZWFuKTogYm9vbGVhbiB7XG4gIGlmIChpZ25vcmVkVkNTKSB7XG4gICAgbGV0IHJlcG9zaXRvcnkgPSBudWxsXG4gICAgY29uc3QgcHJvamVjdFBhdGhzID0gYXRvbS5wcm9qZWN0LmdldFBhdGhzKClcbiAgICBmb3IgKGxldCBpID0gMCwgbGVuZ3RoID0gcHJvamVjdFBhdGhzLmxlbmd0aDsgaSA8IGxlbmd0aDsgKytpKSB7XG4gICAgICBjb25zdCBwcm9qZWN0UGF0aCA9IHByb2plY3RQYXRoc1tpXVxuICAgICAgaWYgKGZpbGVQYXRoLmluZGV4T2YocHJvamVjdFBhdGgpID09PSAwKSB7XG4gICAgICAgIHJlcG9zaXRvcnkgPSBhdG9tLnByb2plY3QuZ2V0UmVwb3NpdG9yaWVzKClbaV1cbiAgICAgICAgYnJlYWtcbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKHJlcG9zaXRvcnkgJiYgcmVwb3NpdG9yeS5pc1BhdGhJZ25vcmVkKGZpbGVQYXRoKSkge1xuICAgICAgcmV0dXJuIHRydWVcbiAgICB9XG4gIH1cbiAgY29uc3Qgbm9ybWFsaXplZEZpbGVQYXRoID0gcHJvY2Vzcy5wbGF0Zm9ybSA9PT0gJ3dpbjMyJyA/IGZpbGVQYXRoLnJlcGxhY2UoL1xcXFwvZywgJy8nKSA6IGZpbGVQYXRoXG4gIHJldHVybiBtaW5pbWF0Y2gobm9ybWFsaXplZEZpbGVQYXRoLCBpZ25vcmVkR2xvYilcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHN1YnNjcmlwdGl2ZU9ic2VydmUob2JqZWN0OiBPYmplY3QsIGV2ZW50TmFtZTogc3RyaW5nLCBjYWxsYmFjazogRnVuY3Rpb24pOiBEaXNwb3NhYmxlIHtcbiAgbGV0IHN1YnNjcmlwdGlvbiA9IG51bGxcbiAgY29uc3QgZXZlbnRTdWJzY3JpcHRpb24gPSBvYmplY3Qub2JzZXJ2ZShldmVudE5hbWUsIGZ1bmN0aW9uKHByb3BzKSB7XG4gICAgaWYgKHN1YnNjcmlwdGlvbikge1xuICAgICAgc3Vic2NyaXB0aW9uLmRpc3Bvc2UoKVxuICAgIH1cbiAgICBzdWJzY3JpcHRpb24gPSBjYWxsYmFjay5jYWxsKHRoaXMsIHByb3BzKVxuICB9KVxuXG4gIHJldHVybiBuZXcgRGlzcG9zYWJsZShmdW5jdGlvbigpIHtcbiAgICBldmVudFN1YnNjcmlwdGlvbi5kaXNwb3NlKClcbiAgICBpZiAoc3Vic2NyaXB0aW9uKSB7XG4gICAgICBzdWJzY3JpcHRpb24uZGlzcG9zZSgpXG4gICAgfVxuICB9KVxufVxuXG5leHBvcnQgZnVuY3Rpb24gbWVzc2FnZUtleShtZXNzYWdlOiBNZXNzYWdlKSB7XG4gIGNvbnN0IHJlZmVyZW5jZSA9IG1lc3NhZ2UucmVmZXJlbmNlXG4gIHJldHVybiBbXG4gICAgYCRMSU5URVI6JHttZXNzYWdlLmxpbnRlck5hbWV9YCxcbiAgICBgJExPQ0FUSU9OOiR7bWVzc2FnZS5sb2NhdGlvbi5maWxlfSQke21lc3NhZ2UubG9jYXRpb24ucG9zaXRpb24uc3RhcnQucm93fSQke21lc3NhZ2UubG9jYXRpb24ucG9zaXRpb24uc3RhcnQuY29sdW1ufSQke21lc3NhZ2UubG9jYXRpb24ucG9zaXRpb24uZW5kLnJvd30kJHttZXNzYWdlLmxvY2F0aW9uLnBvc2l0aW9uLmVuZC5jb2x1bW59YCxcbiAgICByZWZlcmVuY2UgPyBgJFJFRkVSRU5DRToke3JlZmVyZW5jZS5maWxlfSQke3JlZmVyZW5jZS5wb3NpdGlvbiA/IGAke3JlZmVyZW5jZS5wb3NpdGlvbi5yb3d9JCR7cmVmZXJlbmNlLnBvc2l0aW9uLmNvbHVtbn1gIDogJyd9YCA6ICckUkVGRVJFTkNFOm51bGwnLFxuICAgIGAkRVhDRVJQVDoke21lc3NhZ2UuZXhjZXJwdH1gLFxuICAgIGAkU0VWRVJJVFk6JHttZXNzYWdlLnNldmVyaXR5fWAsXG4gICAgbWVzc2FnZS5pY29uID8gYCRJQ09OOiR7bWVzc2FnZS5pY29ufWAgOiAnJElDT046bnVsbCcsXG4gICAgbWVzc2FnZS51cmwgPyBgJFVSTDoke21lc3NhZ2UudXJsfWAgOiAnJFVSTDpudWxsJyxcbiAgXS5qb2luKCcnKVxufVxuXG5leHBvcnQgZnVuY3Rpb24gbm9ybWFsaXplTWVzc2FnZXMobGludGVyTmFtZTogc3RyaW5nLCBtZXNzYWdlczogQXJyYXk8TWVzc2FnZT4pIHtcbiAgZm9yIChsZXQgaSA9IDAsIGxlbmd0aCA9IG1lc3NhZ2VzLmxlbmd0aDsgaSA8IGxlbmd0aDsgKytpKSB7XG4gICAgY29uc3QgbWVzc2FnZSA9IG1lc3NhZ2VzW2ldXG4gICAgY29uc3QgcmVmZXJlbmNlID0gbWVzc2FnZS5yZWZlcmVuY2VcbiAgICBpZiAoQXJyYXkuaXNBcnJheShtZXNzYWdlLmxvY2F0aW9uLnBvc2l0aW9uKSkge1xuICAgICAgbWVzc2FnZS5sb2NhdGlvbi5wb3NpdGlvbiA9IFJhbmdlLmZyb21PYmplY3QobWVzc2FnZS5sb2NhdGlvbi5wb3NpdGlvbilcbiAgICB9XG4gICAgaWYgKHJlZmVyZW5jZSAmJiBBcnJheS5pc0FycmF5KHJlZmVyZW5jZS5wb3NpdGlvbikpIHtcbiAgICAgIHJlZmVyZW5jZS5wb3NpdGlvbiA9IFBvaW50LmZyb21PYmplY3QocmVmZXJlbmNlLnBvc2l0aW9uKVxuICAgIH1cbiAgICBpZiAobWVzc2FnZS5zb2x1dGlvbnMgJiYgbWVzc2FnZS5zb2x1dGlvbnMubGVuZ3RoKSB7XG4gICAgICBmb3IgKGxldCBqID0gMCwgX2xlbmd0aCA9IG1lc3NhZ2Uuc29sdXRpb25zLmxlbmd0aCwgc29sdXRpb247IGogPCBfbGVuZ3RoOyBqKyspIHtcbiAgICAgICAgc29sdXRpb24gPSBtZXNzYWdlLnNvbHV0aW9uc1tqXVxuICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShzb2x1dGlvbi5wb3NpdGlvbikpIHtcbiAgICAgICAgICBzb2x1dGlvbi5wb3NpdGlvbiA9IFJhbmdlLmZyb21PYmplY3Qoc29sdXRpb24ucG9zaXRpb24pXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgbWVzc2FnZS52ZXJzaW9uID0gMlxuICAgIGlmICghbWVzc2FnZS5saW50ZXJOYW1lKSB7XG4gICAgICBtZXNzYWdlLmxpbnRlck5hbWUgPSBsaW50ZXJOYW1lXG4gICAgfVxuICAgIG1lc3NhZ2Uua2V5ID0gbWVzc2FnZUtleShtZXNzYWdlKVxuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBtZXNzYWdlS2V5TGVnYWN5KG1lc3NhZ2U6IE1lc3NhZ2VMZWdhY3kpOiBzdHJpbmcge1xuICByZXR1cm4gW1xuICAgIGAkTElOVEVSOiR7bWVzc2FnZS5saW50ZXJOYW1lfWAsXG4gICAgYCRMT0NBVElPTjoke21lc3NhZ2UuZmlsZVBhdGggfHwgJyd9JCR7bWVzc2FnZS5yYW5nZSA/IGAke21lc3NhZ2UucmFuZ2Uuc3RhcnQucm93fSQke21lc3NhZ2UucmFuZ2Uuc3RhcnQuY29sdW1ufSQke21lc3NhZ2UucmFuZ2UuZW5kLnJvd30kJHttZXNzYWdlLnJhbmdlLmVuZC5jb2x1bW59YCA6ICcnfWAsXG4gICAgYCRURVhUOiR7bWVzc2FnZS50ZXh0IHx8ICcnfWAsXG4gICAgYCRIVE1MOiR7bWVzc2FnZS5odG1sIHx8ICcnfWAsXG4gICAgYCRTRVZFUklUWToke21lc3NhZ2Uuc2V2ZXJpdHl9YCxcbiAgICBgJFRZUEU6JHttZXNzYWdlLnR5cGV9YCxcbiAgICBgJENMQVNTOiR7bWVzc2FnZS5jbGFzcyB8fCAnJ31gLFxuICBdLmpvaW4oJycpXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBub3JtYWxpemVNZXNzYWdlc0xlZ2FjeShsaW50ZXJOYW1lOiBzdHJpbmcsIG1lc3NhZ2VzOiBBcnJheTxNZXNzYWdlTGVnYWN5Pikge1xuICBmb3IgKGxldCBpID0gMCwgbGVuZ3RoID0gbWVzc2FnZXMubGVuZ3RoOyBpIDwgbGVuZ3RoOyArK2kpIHtcbiAgICBjb25zdCBtZXNzYWdlID0gbWVzc2FnZXNbaV1cbiAgICBjb25zdCBmaXggPSBtZXNzYWdlLmZpeFxuICAgIGlmIChtZXNzYWdlLnJhbmdlICYmIG1lc3NhZ2UucmFuZ2UuY29uc3RydWN0b3IubmFtZSA9PT0gJ0FycmF5Jykge1xuICAgICAgbWVzc2FnZS5yYW5nZSA9IFJhbmdlLmZyb21PYmplY3QobWVzc2FnZS5yYW5nZSlcbiAgICB9XG4gICAgaWYgKGZpeCAmJiBmaXgucmFuZ2UuY29uc3RydWN0b3IubmFtZSA9PT0gJ0FycmF5Jykge1xuICAgICAgZml4LnJhbmdlID0gUmFuZ2UuZnJvbU9iamVjdChmaXgucmFuZ2UpXG4gICAgfVxuICAgIGlmICghbWVzc2FnZS5zZXZlcml0eSkge1xuICAgICAgY29uc3QgdHlwZSA9IG1lc3NhZ2UudHlwZS50b0xvd2VyQ2FzZSgpXG4gICAgICBpZiAodHlwZSA9PT0gJ3dhcm5pbmcnKSB7XG4gICAgICAgIG1lc3NhZ2Uuc2V2ZXJpdHkgPSB0eXBlXG4gICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdpbmZvJyB8fCB0eXBlID09PSAndHJhY2UnKSB7XG4gICAgICAgIG1lc3NhZ2Uuc2V2ZXJpdHkgPSAnaW5mbydcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIG1lc3NhZ2Uuc2V2ZXJpdHkgPSAnZXJyb3InXG4gICAgICB9XG4gICAgfVxuICAgIG1lc3NhZ2UudmVyc2lvbiA9IDFcbiAgICBtZXNzYWdlLmxpbnRlck5hbWUgPSBsaW50ZXJOYW1lXG4gICAgbWVzc2FnZS5rZXkgPSBtZXNzYWdlS2V5TGVnYWN5KG1lc3NhZ2UpXG5cbiAgICBpZiAobWVzc2FnZS50cmFjZSkge1xuICAgICAgbm9ybWFsaXplTWVzc2FnZXNMZWdhY3kobGludGVyTmFtZSwgbWVzc2FnZS50cmFjZSlcbiAgICB9XG4gIH1cbn1cbiJdfQ==