Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.normalizeString = normalizeString;
exports.getRow = getRow;
exports.getTextInRange = getTextInRange;
exports.getRows = getRows;
exports.getSelectedText = getSelectedText;
exports.isComment = isComment;
exports.isBlank = isBlank;
exports.escapeBlankRows = escapeBlankRows;
exports.getFoldRange = getFoldRange;
exports.getFoldContents = getFoldContents;
exports.getCodeToInspect = getCodeToInspect;
exports.getRegexString = getRegexString;
exports.getBreakpoints = getBreakpoints;
exports.getCurrentCell = getCurrentCell;
exports.getCells = getCells;
exports.getCellsForBreakPoints = getCellsForBreakPoints;
exports.moveDown = moveDown;
exports.findPrecedingBlock = findPrecedingBlock;
exports.findCodeBlock = findCodeBlock;

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

var _atom = require("atom");

var _escapeStringRegexp = require("escape-string-regexp");

var _escapeStringRegexp2 = _interopRequireDefault(_escapeStringRegexp);

var _lodash = require("lodash");

var _lodash2 = _interopRequireDefault(_lodash);

var _utils = require("./utils");

function normalizeString(code) {
  if (code) {
    return code.replace(/\r\n|\r/g, "\n").trim();
  }
  return null;
}

function getRow(editor, row) {
  return normalizeString(editor.lineTextForBufferRow(row));
}

function getTextInRange(editor, start, end) {
  var code = editor.getTextInBufferRange([start, end]);
  return normalizeString(code);
}

function getRows(editor, startRow, endRow) {
  var code = editor.getTextInBufferRange({
    start: {
      row: startRow,
      column: 0
    },
    end: {
      row: endRow,
      column: 9999999
    }
  });
  return normalizeString(code);
}

function getSelectedText(editor) {
  return normalizeString(editor.getSelectedText());
}

function isComment(editor, position) {
  var scope = editor.scopeDescriptorForBufferPosition(position);
  var scopeString = scope.getScopeChain();
  return _lodash2["default"].includes(scopeString, "comment.line");
}

function isBlank(editor, row) {
  return editor.getBuffer().isRowBlank(row) || editor.isBufferRowCommented(row);
}

function escapeBlankRows(editor, startRow, endRow) {
  while (endRow > startRow) {
    if (!isBlank(editor, endRow)) break;
    endRow -= 1;
  }
  return endRow;
}

function getFoldRange(editor, row) {
  var range = (0, _utils.rowRangeForCodeFoldAtBufferRow)(editor, row);
  if (!range) return;
  if (range[1] < editor.getLastBufferRow() && getRow(editor, range[1] + 1) === "end") {
    range[1] += 1;
  }
  (0, _utils.log)("getFoldRange:", range);
  return range;
}

function getFoldContents(editor, row) {
  var range = getFoldRange(editor, row);
  if (!range) return;
  return [getRows(editor, range[0], range[1]), range[1]];
}

function getCodeToInspect(editor) {
  var selectedText = getSelectedText(editor);
  var code = undefined;
  var cursorPosition = undefined;
  if (selectedText) {
    code = selectedText;
    cursorPosition = code.length;
  } else {
    var cursor = editor.getLastCursor();
    var row = cursor.getBufferRow();
    code = getRow(editor, row);
    cursorPosition = cursor.getBufferColumn();

    // TODO: use kernel.complete to find a selection
    var identifierEnd = code ? code.slice(cursorPosition).search(/\W/) : -1;
    if (identifierEnd !== -1) {
      cursorPosition += identifierEnd;
    }
  }

  return [code, cursorPosition];
}

function getRegexString(editor) {
  var _editor$tokenizedBuffer$commentStringsForPosition =
  // $FlowFixMe: This is an unofficial API
  editor.tokenizedBuffer.commentStringsForPosition(editor.getCursorBufferPosition());

  var commentStartString = _editor$tokenizedBuffer$commentStringsForPosition.commentStartString;

  if (!commentStartString) {
    (0, _utils.log)("CellManager: No comment string defined in root scope");
    return null;
  }

  var escapedCommentStartString = (0, _escapeStringRegexp2["default"])(commentStartString.trimRight());

  var regexString = escapedCommentStartString + "(%%| %%| <codecell>| In[[0-9 ]*]:?)";

  return regexString;
}

function getBreakpoints(editor) {
  var buffer = editor.getBuffer();
  var breakpoints = [];

  var regexString = getRegexString(editor);
  if (regexString) {
    var regex = new RegExp(regexString, "g");
    buffer.scan(regex, function (_ref) {
      var range = _ref.range;

      breakpoints.push(range.start);
    });
  }

  breakpoints.push(buffer.getEndPosition());

  (0, _utils.log)("CellManager: Breakpoints:", breakpoints);

  return breakpoints;
}

function getCurrentCodeCell(editor) {
  var buffer = editor.getBuffer();
  var start = new _atom.Point(0, 0);
  var end = buffer.getEndPosition();
  var regexString = getRegexString(editor);

  if (!regexString) {
    return new _atom.Range(start, end);
  }

  var regex = new RegExp(regexString);
  var cursor = editor.getCursorBufferPosition();

  while (cursor.row < end.row && isComment(editor, cursor)) {
    cursor.row += 1;
    cursor.column = 0;
  }

  if (cursor.row > 0) {
    buffer.backwardsScanInRange(regex, new _atom.Range(start, cursor), function (_ref2) {
      var range = _ref2.range;

      start = new _atom.Point(range.start.row + 1, 0);
    });
  }

  buffer.scanInRange(regex, new _atom.Range(cursor, end), function (_ref3) {
    var range = _ref3.range;

    end = range.start;
  });

  (0, _utils.log)("CellManager: Cell [start, end]:", [start, end], "cursor:", cursor);

  return new _atom.Range(start, end);
}

function isEmbeddedCode(editor, referenceScope, row) {
  var scopes = editor.scopeDescriptorForBufferPosition(new _atom.Point(row, 0)).getScopesArray();
  return _lodash2["default"].includes(scopes, referenceScope);
}

function getCurrentFencedCodeBlock(editor) {
  var buffer = editor.getBuffer();

  var _buffer$getEndPosition = buffer.getEndPosition();

  var bufferEndRow = _buffer$getEndPosition.row;

  var cursor = editor.getCursorBufferPosition();
  var start = cursor.row;
  var end = cursor.row;
  var scope = (0, _utils.getEmbeddedScope)(editor, cursor);
  if (!scope) return getCurrentCodeCell(editor);
  while (start > 0 && isEmbeddedCode(editor, scope, start - 1)) {
    start -= 1;
  }

  while (end < bufferEndRow && isEmbeddedCode(editor, scope, end + 1)) {
    end += 1;
  }

  return new _atom.Range([start, 0], [end, 9999999]);
}

function getCurrentCell(editor) {
  if ((0, _utils.isMultilanguageGrammar)(editor.getGrammar())) {
    return getCurrentFencedCodeBlock(editor);
  }
  return getCurrentCodeCell(editor);
}

function getCells(editor) {
  var breakpoints = arguments.length <= 1 || arguments[1] === undefined ? [] : arguments[1];

  if (breakpoints.length !== 0) {
    breakpoints.sort(function (a, b) {
      return a.compare(b);
    });
  } else {
    breakpoints = getBreakpoints(editor);
  }
  return getCellsForBreakPoints(breakpoints);
}

function getCellsForBreakPoints(breakpoints) {
  var start = new _atom.Point(0, 0);
  return _lodash2["default"].map(breakpoints, function (end) {
    var cell = new _atom.Range(start, end);
    start = new _atom.Point(end.row + 1, 0);
    return cell;
  });
}

function moveDown(editor, row) {
  var lastRow = editor.getLastBufferRow();

  if (row >= lastRow) {
    editor.moveToBottom();
    editor.insertNewline();
    return;
  }

  while (row < lastRow) {
    row += 1;
    if (!isBlank(editor, row)) break;
  }

  editor.setCursorBufferPosition({
    row: row,
    column: 0
  });
}

function findPrecedingBlock(editor, row, indentLevel) {
  var previousRow = row - 1;
  while (previousRow >= 0) {
    var previousIndentLevel = editor.indentationForBufferRow(previousRow);
    var sameIndent = previousIndentLevel <= indentLevel;
    var blank = isBlank(editor, previousRow);
    var isEnd = getRow(editor, previousRow) === "end";

    if (isBlank(editor, row)) {
      row = previousRow;
    }
    if (sameIndent && !blank && !isEnd) {
      return [getRows(editor, previousRow, row), row];
    }
    previousRow -= 1;
  }
  return null;
}

function findCodeBlock(editor) {
  var selectedText = getSelectedText(editor);

  if (selectedText) {
    var selectedRange = editor.getSelectedBufferRange();
    var endRow = selectedRange.end.row;
    if (selectedRange.end.column === 0) {
      endRow -= 1;
    }
    endRow = escapeBlankRows(editor, selectedRange.start.row, endRow);
    return [selectedText, endRow];
  }

  var cursor = editor.getLastCursor();

  var row = cursor.getBufferRow();
  (0, _utils.log)("findCodeBlock:", row);

  var indentLevel = cursor.getIndentLevel();
  var foldable = editor.isFoldableAtBufferRow(row);
  var foldRange = (0, _utils.rowRangeForCodeFoldAtBufferRow)(editor, row);
  if (!foldRange || foldRange[0] == null || foldRange[1] == null) {
    foldable = false;
  }

  if (foldable) {
    return getFoldContents(editor, row);
  }
  if (isBlank(editor, row) || getRow(editor, row) === "end") {
    return findPrecedingBlock(editor, row, indentLevel);
  }
  return [getRow(editor, row), row];
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9Vc2Vycy9ldmFuaGVuZHJpeDEvLmF0b20vcGFja2FnZXMvSHlkcm9nZW4vbGliL2NvZGUtbWFuYWdlci5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O29CQUU2QixNQUFNOztrQ0FFSixzQkFBc0I7Ozs7c0JBQ3ZDLFFBQVE7Ozs7cUJBT2YsU0FBUzs7QUFFVCxTQUFTLGVBQWUsQ0FBQyxJQUFhLEVBQUU7QUFDN0MsTUFBSSxJQUFJLEVBQUU7QUFDUixXQUFPLElBQUksQ0FBQyxPQUFPLENBQUMsVUFBVSxFQUFFLElBQUksQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDO0dBQzlDO0FBQ0QsU0FBTyxJQUFJLENBQUM7Q0FDYjs7QUFFTSxTQUFTLE1BQU0sQ0FBQyxNQUF1QixFQUFFLEdBQVcsRUFBRTtBQUMzRCxTQUFPLGVBQWUsQ0FBQyxNQUFNLENBQUMsb0JBQW9CLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztDQUMxRDs7QUFFTSxTQUFTLGNBQWMsQ0FDNUIsTUFBdUIsRUFDdkIsS0FBaUIsRUFDakIsR0FBZSxFQUNmO0FBQ0EsTUFBTSxJQUFJLEdBQUcsTUFBTSxDQUFDLG9CQUFvQixDQUFDLENBQUMsS0FBSyxFQUFFLEdBQUcsQ0FBQyxDQUFDLENBQUM7QUFDdkQsU0FBTyxlQUFlLENBQUMsSUFBSSxDQUFDLENBQUM7Q0FDOUI7O0FBRU0sU0FBUyxPQUFPLENBQ3JCLE1BQXVCLEVBQ3ZCLFFBQWdCLEVBQ2hCLE1BQWMsRUFDZDtBQUNBLE1BQU0sSUFBSSxHQUFHLE1BQU0sQ0FBQyxvQkFBb0IsQ0FBQztBQUN2QyxTQUFLLEVBQUU7QUFDTCxTQUFHLEVBQUUsUUFBUTtBQUNiLFlBQU0sRUFBRSxDQUFDO0tBQ1Y7QUFDRCxPQUFHLEVBQUU7QUFDSCxTQUFHLEVBQUUsTUFBTTtBQUNYLFlBQU0sRUFBRSxPQUFPO0tBQ2hCO0dBQ0YsQ0FBQyxDQUFDO0FBQ0gsU0FBTyxlQUFlLENBQUMsSUFBSSxDQUFDLENB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QUFHLENBQUMsQ0FBQztBQUNqRCxNQUFNLFNBQVMsR0FBRywyQ0FBK0IsTUFBTSxFQUFFLEdBQUcsQ0FBQyxDQUFDO0FBQzlELE1BQUksQ0FBQyxTQUFTLElBQUksU0FBUyxDQUFDLENBQUMsQ0FBQyxJQUFJLElBQUksSUFBSSxTQUFTLENBQUMsQ0FBQyxDQUFDLElBQUksSUFBSSxFQUFFO0FBQzlELFlBQVEsR0FBRyxLQUFLLENBQUM7R0FDbEI7O0FBRUQsTUFBSSxRQUFRLEVBQUU7QUFDWixXQUFPLGVBQWUsQ0FBQyxNQUFNLEVBQUUsR0FBRyxDQUFDLENBQUM7R0FDckM7QUFDRCxNQUFJLE9BQU8sQ0FBQyxNQUFNLEVBQUUsR0FBRyxDQUFDLElBQUksTUFBTSxDQUFDLE1BQU0sRUFBRSxHQUFHLENBQUMsS0FBSyxLQUFLLEVBQUU7QUFDekQsV0FBTyxrQkFBa0IsQ0FBQyxNQUFNLEVBQUUsR0FBRyxFQUFFLFdBQVcsQ0FBQyxDQUFDO0dBQ3JEO0FBQ0QsU0FBTyxDQUFDLE1BQU0sQ0FBQyxNQUFNLEVBQUUsR0FBRyxDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUM7Q0FDbkMiLCJmaWxlIjoiL1VzZXJzL2V2YW5oZW5kcml4MS8uYXRvbS9wYWNrYWdlcy9IeWRyb2dlbi9saWIvY29kZS1tYW5hZ2VyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyogQGZsb3cgKi9cblxuaW1wb3J0IHsgUG9pbnQsIFJhbmdlIH0gZnJvbSBcImF0b21cIjtcblxuaW1wb3J0IGVzY2FwZVN0cmluZ1JlZ2V4cCBmcm9tIFwiZXNjYXBlLXN0cmluZy1yZWdleHBcIjtcbmltcG9ydCBfIGZyb20gXCJsb2Rhc2hcIjtcblxuaW1wb3J0IHtcbiAgbG9nLFxuICBpc011bHRpbGFuZ3VhZ2VHcmFtbWFyLFxuICBnZXRFbWJlZGRlZFNjb3BlLFxuICByb3dSYW5nZUZvckNvZGVGb2xkQXRCdWZmZXJSb3dcbn0gZnJvbSBcIi4vdXRpbHNcIjtcblxuZXhwb3J0IGZ1bmN0aW9uIG5vcm1hbGl6ZVN0cmluZyhjb2RlOiA/c3RyaW5nKSB7XG4gIGlmIChjb2RlKSB7XG4gICAgcmV0dXJuIGNvZGUucmVwbGFjZSgvXFxyXFxufFxcci9nLCBcIlxcblwiKS50cmltKCk7XG4gIH1cbiAgcmV0dXJuIG51bGw7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRSb3coZWRpdG9yOiBhdG9tJFRleHRFZGl0b3IsIHJvdzogbnVtYmVyKSB7XG4gIHJldHVybiBub3JtYWxpemVTdHJpbmcoZWRpdG9yLmxpbmVUZXh0Rm9yQnVmZmVyUm93KHJvdykpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0VGV4dEluUmFuZ2UoXG4gIGVkaXRvcjogYXRvbSRUZXh0RWRpdG9yLFxuICBzdGFydDogYXRvbSRQb2ludCxcbiAgZW5kOiBhdG9tJFBvaW50XG4pIHtcbiAgY29uc3QgY29kZSA9IGVkaXRvci5nZXRUZXh0SW5CdWZmZXJSYW5nZShbc3RhcnQsIGVuZF0pO1xuICByZXR1cm4gbm9ybWFsaXplU3RyaW5nKGNvZGUpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0Um93cyhcbiAgZWRpdG9yOiBhdG9tJFRleHRFZGl0b3IsXG4gIHN0YXJ0Um93OiBudW1iZXIsXG4gIGVuZFJvdzogbnVtYmVyXG4pIHtcbiAgY29uc3QgY29kZSA9IGVkaXRvci5nZXRUZXh0SW5CdWZmZXJSYW5nZSh7XG4gICAgc3RhcnQ6IHtcbiAgICAgIHJvdzogc3RhcnRSb3csXG4gICAgICBjb2x1bW46IDBcbiAgICB9LFxuICAgIGVuZDoge1xuICAgICAgcm93OiBlbmRSb3csXG4gICAgICBjb2x1bW46IDk5OTk5OTlcbiAgICB9XG4gIH0pO1xuICByZXR1cm4gbm9ybWFsaXplU3RyaW5nKGNvZGUpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0U2VsZWN0ZWRUZXh0KGVkaXRvcjogYXRvbSRUZXh0RWRpdG9yKSB7XG4gIHJldHVybiBub3JtYWxpemVTdHJpbmcoZWRpdG9yLmdldFNlbGVjdGVkVGV4dCgpKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGlzQ29tbWVudChlZGl0b3I6IGF0b20kVGV4dEVkaXRvciwgcG9zaXRpb246IGF0b20kUG9pbnQpIHtcbiAgY29uc3Qgc2NvcGUgPSBlZGl0b3Iuc2NvcGVEZXNjcmlwdG9yRm9yQnVmZmVyUG9zaXRpb24ocG9zaXRpb24pO1xuICBjb25zdCBzY29wZVN0cmluZyA9IHNjb3BlLmdldFNjb3BlQ2hhaW4oKTtcbiAgcmV0dXJuIF8uaW5jbHVkZXMoc2NvcGVTdHJpbmcsIFwiY29tbWVudC5saW5lXCIpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gaXNCbGFuayhlZGl0b3I6IGF0b20kVGV4dEVkaXRvciwgcm93OiBudW1iZXIpIHtcbiAgcmV0dXJuIGVkaXRvci5nZXRCdWZmZXIoKS5pc1Jvd0JsYW5rKHJvdykgfHwgZWRpdG9yLmlzQnVmZmVyUm93Q29tbWVudGVkKHJvdyk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBlc2NhcGVCbGFua1Jvd3MoXG4gIGVkaXRvcjogYXRvbSRUZXh0RWRpdG9yLFxuICBzdGFydFJvdzogbnVtYmVyLFxuICBlbmRSb3c6IG51bWJlclxuKSB7XG4gIHdoaWxlIChlbmRSb3cgPiBzdGFydFJvdykge1xuICAgIGlmICghaXNCbGFuayhlZGl0b3IsIGVuZFJvdykpIGJyZWFrO1xuICAgIGVuZFJvdyAtPSAxO1xuICB9XG4gIHJldHVybiBlbmRSb3c7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRGb2xkUmFuZ2UoZWRpdG9yOiBhdG9tJFRleHRFZGl0b3IsIHJvdzogbnVtYmVyKSB7XG4gIGNvbnN0IHJhbmdlID0gcm93UmFuZ2VGb3JDb2RlRm9sZEF0QnVmZmVyUm93KGVkaXRvciwgcm93KTtcbiAgaWYgKCFyYW5nZSkgcmV0dXJuO1xuICBpZiAoXG4gICAgcmFuZ2VbMV0gPCBlZGl0b3IuZ2V0TGFzdEJ1ZmZlclJvdygpICYmXG4gICAgZ2V0Um93KGVkaXRvciwgcmFuZ2VbMV0gKyAxKSA9PT0gXCJlbmRcIlxuICApIHtcbiAgICByYW5nZVsxXSArPSAxO1xuICB9XG4gIGxvZyhcImdldEZvbGRSYW5nZTpcIiwgcmFuZ2UpO1xuICByZXR1cm4gcmFuZ2U7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRGb2xkQ29udGVudHMoZWRpdG9yOiBhdG9tJFRleHRFZGl0b3IsIHJvdzogbnVtYmVyKSB7XG4gIGNvbnN0IHJhbmdlID0gZ2V0Rm9sZFJhbmdlKGVkaXRvciwgcm93KTtcbiAgaWYgKCFyYW5nZSkgcmV0dXJuO1xuICByZXR1cm4gW2dldFJvd3MoZWRpdG9yLCByYW5nZVswXSwgcmFuZ2VbMV0pLCByYW5nZVsxXV07XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRDb2RlVG9JbnNwZWN0KGVkaXRvcjogYXRvbSRUZXh0RWRpdG9yKSB7XG4gIGNvbnN0IHNlbGVjdGVkVGV4dCA9IGdldFNlbGVjdGVkVGV4dChlZGl0b3IpO1xuICBsZXQgY29kZTtcbiAgbGV0IGN1cnNvclBvc2l0aW9uO1xuICBpZiAoc2VsZWN0ZWRUZXh0KSB7XG4gICAgY29kZSA9IHNlbGVjdGVkVGV4dDtcbiAgICBjdXJzb3JQb3NpdGlvbiA9IGNvZGUubGVuZ3RoO1xuICB9IGVsc2Uge1xuICAgIGNvbnN0IGN1cnNvciA9IGVkaXRvci5nZXRMYXN0Q3Vyc29yKCk7XG4gICAgY29uc3Qgcm93ID0gY3Vyc29yLmdldEJ1ZmZlclJvdygpO1xuICAgIGNvZGUgPSBnZXRSb3coZWRpdG9yLCByb3cpO1xuICAgIGN1cnNvclBvc2l0aW9uID0gY3Vyc29yLmdldEJ1ZmZlckNvbHVtbigpO1xuXG4gICAgLy8gVE9ETzogdXNlIGtlcm5lbC5jb21wbGV0ZSB0byBmaW5kIGEgc2VsZWN0aW9uXG4gICAgY29uc3QgaWRlbnRpZmllckVuZCA9IGNvZGUgPyBjb2RlLnNsaWNlKGN1cnNvclBvc2l0aW9uKS5zZWFyY2goL1xcVy8pIDogLTE7XG4gICAgaWYgKGlkZW50aWZpZXJFbmQgIT09IC0xKSB7XG4gICAgICBjdXJzb3JQb3NpdGlvbiArPSBpZGVudGlmaWVyRW5kO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiBbY29kZSwgY3Vyc29yUG9zaXRpb25dO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0UmVnZXhTdHJpbmcoZWRpdG9yOiBhdG9tJFRleHRFZGl0b3IpIHtcbiAgY29uc3Qge1xuICAgIGNvbW1lbnRTdGFydFN0cmluZ1xuICAgIC8vICRGbG93Rml4TWU6IFRoaXMgaXMgYW4gdW5vZmZpY2lhbCBBUElcbiAgfSA9IGVkaXRvci50b2tlbml6ZWRCdWZmZXIuY29tbWVudFN0cmluZ3NGb3JQb3NpdGlvbihcbiAgICBlZGl0b3IuZ2V0Q3Vyc29yQnVmZmVyUG9zaXRpb24oKVxuICApO1xuXG4gIGlmICghY29tbWVudFN0YXJ0U3RyaW5nKSB7XG4gICAgbG9nKFwiQ2VsbE1hbmFnZXI6IE5vIGNvbW1lbnQgc3RyaW5nIGRlZmluZWQgaW4gcm9vdCBzY29wZVwiKTtcbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIGNvbnN0IGVzY2FwZWRDb21tZW50U3RhcnRTdHJpbmcgPSBlc2NhcGVTdHJpbmdSZWdleHAoXG4gICAgY29tbWVudFN0YXJ0U3RyaW5nLnRyaW1SaWdodCgpXG4gICk7XG5cbiAgY29uc3QgcmVnZXhTdHJpbmcgPSBgJHtcbiAgICBlc2NhcGVkQ29tbWVudFN0YXJ0U3RyaW5nXG4gIH0oJSV8ICUlfCA8Y29kZWNlbGw+fCBJblxcW1swLTkgXSpcXF06PylgO1xuXG4gIHJldHVybiByZWdleFN0cmluZztcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldEJyZWFrcG9pbnRzKGVkaXRvcjogYXRvbSRUZXh0RWRpdG9yKSB7XG4gIGNvbnN0IGJ1ZmZlciA9IGVkaXRvci5nZXRCdWZmZXIoKTtcbiAgY29uc3QgYnJlYWtwb2ludHMgPSBbXTtcblxuICBjb25zdCByZWdleFN0cmluZyA9IGdldFJlZ2V4U3RyaW5nKGVkaXRvcik7XG4gIGlmIChyZWdleFN0cmluZykge1xuICAgIGNvbnN0IHJlZ2V4ID0gbmV3IFJlZ0V4cChyZWdleFN0cmluZywgXCJnXCIpO1xuICAgIGJ1ZmZlci5zY2FuKHJlZ2V4LCAoeyByYW5nZSB9KSA9PiB7XG4gICAgICBicmVha3BvaW50cy5wdXNoKHJhbmdlLnN0YXJ0KTtcbiAgICB9KTtcbiAgfVxuXG4gIGJyZWFrcG9pbnRzLnB1c2goYnVmZmVyLmdldEVuZFBvc2l0aW9uKCkpO1xuXG4gIGxvZyhcIkNlbGxNYW5hZ2VyOiBCcmVha3BvaW50czpcIiwgYnJlYWtwb2ludHMpO1xuXG4gIHJldHVybiBicmVha3BvaW50cztcbn1cblxuZnVuY3Rpb24gZ2V0Q3VycmVudENvZGVDZWxsKGVkaXRvcjogYXRvbSRUZXh0RWRpdG9yKSB7XG4gIGNvbnN0IGJ1ZmZlciA9IGVkaXRvci5nZXRCdWZmZXIoKTtcbiAgbGV0IHN0YXJ0ID0gbmV3IFBvaW50KDAsIDApO1xuICBsZXQgZW5kID0gYnVmZmVyLmdldEVuZFBvc2l0aW9uKCk7XG4gIGNvbnN0IHJlZ2V4U3RyaW5nID0gZ2V0UmVnZXhTdHJpbmcoZWRpdG9yKTtcblxuICBpZiAoIXJlZ2V4U3RyaW5nKSB7XG4gICAgcmV0dXJuIG5ldyBSYW5nZShzdGFydCwgZW5kKTtcbiAgfVxuXG4gIGNvbnN0IHJlZ2V4ID0gbmV3IFJlZ0V4cChyZWdleFN0cmluZyk7XG4gIGNvbnN0IGN1cnNvciA9IGVkaXRvci5nZXRDdXJzb3JCdWZmZXJQb3NpdGlvbigpO1xuXG4gIHdoaWxlIChjdXJzb3Iucm93IDwgZW5kLnJvdyAmJiBpc0NvbW1lbnQoZWRpdG9yLCBjdXJzb3IpKSB7XG4gICAgY3Vyc29yLnJvdyArPSAxO1xuICAgIGN1cnNvci5jb2x1bW4gPSAwO1xuICB9XG5cbiAgaWYgKGN1cnNvci5yb3cgPiAwKSB7XG4gICAgYnVmZmVyLmJhY2t3YXJkc1NjYW5JblJhbmdlKFxuICAgICAgcmVnZXgsXG4gICAgICBuZXcgUmFuZ2Uoc3RhcnQsIGN1cnNvciksXG4gICAgICAoeyByYW5nZSB9KSA9PiB7XG4gICAgICAgIHN0YXJ0ID0gbmV3IFBvaW50KHJhbmdlLnN0YXJ0LnJvdyArIDEsIDApO1xuICAgICAgfVxuICAgICk7XG4gIH1cblxuICBidWZmZXIuc2NhbkluUmFuZ2UocmVnZXgsIG5ldyBSYW5nZShjdXJzb3IsIGVuZCksICh7IHJhbmdlIH0pID0+IHtcbiAgICBlbmQgPSByYW5nZS5zdGFydDtcbiAgfSk7XG5cbiAgbG9nKFwiQ2VsbE1hbmFnZXI6IENlbGwgW3N0YXJ0LCBlbmRdOlwiLCBbc3RhcnQsIGVuZF0sIFwiY3Vyc29yOlwiLCBjdXJzb3IpO1xuXG4gIHJldHVybiBuZXcgUmFuZ2Uoc3RhcnQsIGVuZCk7XG59XG5cbmZ1bmN0aW9uIGlzRW1iZWRkZWRDb2RlKFxuICBlZGl0b3I6IGF0b20kVGV4dEVkaXRvcixcbiAgcmVmZXJlbmNlU2NvcGU6IHN0cmluZyxcbiAgcm93OiBudW1iZXJcbikge1xuICBjb25zdCBzY29wZXMgPSBlZGl0b3JcbiAgICAuc2NvcGVEZXNjcmlwdG9yRm9yQnVmZmVyUG9zaXRpb24obmV3IFBvaW50KHJvdywgMCkpXG4gICAgLmdldFNjb3Blc0FycmF5KCk7XG4gIHJldHVybiBfLmluY2x1ZGVzKHNjb3BlcywgcmVmZXJlbmNlU2NvcGUpO1xufVxuXG5mdW5jdGlvbiBnZXRDdXJyZW50RmVuY2VkQ29kZUJsb2NrKGVkaXRvcjogYXRvbSRUZXh0RWRpdG9yKSB7XG4gIGNvbnN0IGJ1ZmZlciA9IGVkaXRvci5nZXRCdWZmZXIoKTtcbiAgY29uc3QgeyByb3c6IGJ1ZmZlckVuZFJvdyB9ID0gYnVmZmVyLmdldEVuZFBvc2l0aW9uKCk7XG5cbiAgY29uc3QgY3Vyc29yID0gZWRpdG9yLmdldEN1cnNvckJ1ZmZlclBvc2l0aW9uKCk7XG4gIGxldCBzdGFydCA9IGN1cnNvci5yb3c7XG4gIGxldCBlbmQgPSBjdXJzb3Iucm93O1xuICBjb25zdCBzY29wZSA9IGdldEVtYmVkZGVkU2NvcGUoZWRpdG9yLCBjdXJzb3IpO1xuICBpZiAoIXNjb3BlKSByZXR1cm4gZ2V0Q3VycmVudENvZGVDZWxsKGVkaXRvcik7XG4gIHdoaWxlIChzdGFydCA+IDAgJiYgaXNFbWJlZGRlZENvZGUoZWRpdG9yLCBzY29wZSwgc3RhcnQgLSAxKSkge1xuICAgIHN0YXJ0IC09IDE7XG4gIH1cblxuICB3aGlsZSAoZW5kIDwgYnVmZmVyRW5kUm93ICYmIGlzRW1iZWRkZWRDb2RlKGVkaXRvciwgc2NvcGUsIGVuZCArIDEpKSB7XG4gICAgZW5kICs9IDE7XG4gIH1cblxuICByZXR1cm4gbmV3IFJhbmdlKFtzdGFydCwgMF0sIFtlbmQsIDk5OTk5OTldKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldEN1cnJlbnRDZWxsKGVkaXRvcjogYXRvbSRUZXh0RWRpdG9yKSB7XG4gIGlmIChpc011bHRpbGFuZ3VhZ2VHcmFtbWFyKGVkaXRvci5nZXRHcmFtbWFyKCkpKSB7XG4gICAgcmV0dXJuIGdldEN1cnJlbnRGZW5jZWRDb2RlQmxvY2soZWRpdG9yKTtcbiAgfVxuICByZXR1cm4gZ2V0Q3VycmVudENvZGVDZWxsKGVkaXRvcik7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRDZWxscyhcbiAgZWRpdG9yOiBhdG9tJFRleHRFZGl0b3IsXG4gIGJyZWFrcG9pbnRzOiBBcnJheTxhdG9tJFBvaW50PiA9IFtdXG4pIHtcbiAgaWYgKGJyZWFrcG9pbnRzLmxlbmd0aCAhPT0gMCkge1xuICAgIGJyZWFrcG9pbnRzLnNvcnQoKGEsIGIpID0+IGEuY29tcGFyZShiKSk7XG4gIH0gZWxzZSB7XG4gICAgYnJlYWtwb2ludHMgPSBnZXRCcmVha3BvaW50cyhlZGl0b3IpO1xuICB9XG4gIHJldHVybiBnZXRDZWxsc0ZvckJyZWFrUG9pbnRzKGJyZWFrcG9pbnRzKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldENlbGxzRm9yQnJlYWtQb2ludHMoYnJlYWtwb2ludHM6IEFycmF5PGF0b20kUG9pbnQ+KSB7XG4gIGxldCBzdGFydCA9IG5ldyBQb2ludCgwLCAwKTtcbiAgcmV0dXJuIF8ubWFwKGJyZWFrcG9pbnRzLCBlbmQgPT4ge1xuICAgIGNvbnN0IGNlbGwgPSBuZXcgUmFuZ2Uoc3RhcnQsIGVuZCk7XG4gICAgc3RhcnQgPSBuZXcgUG9pbnQoZW5kLnJvdyArIDEsIDApO1xuICAgIHJldHVybiBjZWxsO1xuICB9KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIG1vdmVEb3duKGVkaXRvcjogYXRvbSRUZXh0RWRpdG9yLCByb3c6IG51bWJlcikge1xuICBjb25zdCBsYXN0Um93ID0gZWRpdG9yLmdldExhc3RCdWZmZXJSb3coKTtcblxuICBpZiAocm93ID49IGxhc3RSb3cpIHtcbiAgICBlZGl0b3IubW92ZVRvQm90dG9tKCk7XG4gICAgZWRpdG9yLmluc2VydE5ld2xpbmUoKTtcbiAgICByZXR1cm47XG4gIH1cblxuICB3aGlsZSAocm93IDwgbGFzdFJvdykge1xuICAgIHJvdyArPSAxO1xuICAgIGlmICghaXNCbGFuayhlZGl0b3IsIHJvdykpIGJyZWFrO1xuICB9XG5cbiAgZWRpdG9yLnNldEN1cnNvckJ1ZmZlclBvc2l0aW9uKHtcbiAgICByb3csXG4gICAgY29sdW1uOiAwXG4gIH0pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZmluZFByZWNlZGluZ0Jsb2NrKFxuICBlZGl0b3I6IGF0b20kVGV4dEVkaXRvcixcbiAgcm93OiBudW1iZXIsXG4gIGluZGVudExldmVsOiBudW1iZXJcbikge1xuICBsZXQgcHJldmlvdXNSb3cgPSByb3cgLSAxO1xuICB3aGlsZSAocHJldmlvdXNSb3cgPj0gMCkge1xuICAgIGNvbnN0IHByZXZpb3VzSW5kZW50TGV2ZWwgPSBlZGl0b3IuaW5kZW50YXRpb25Gb3JCdWZmZXJSb3cocHJldmlvdXNSb3cpO1xuICAgIGNvbnN0IHNhbWVJbmRlbnQgPSBwcmV2aW91c0luZGVudExldmVsIDw9IGluZGVudExldmVsO1xuICAgIGNvbnN0IGJsYW5rID0gaXNCbGFuayhlZGl0b3IsIHByZXZpb3VzUm93KTtcbiAgICBjb25zdCBpc0VuZCA9IGdldFJvdyhlZGl0b3IsIHByZXZpb3VzUm93KSA9PT0gXCJlbmRcIjtcblxuICAgIGlmIChpc0JsYW5rKGVkaXRvciwgcm93KSkge1xuICAgICAgcm93ID0gcHJldmlvdXNSb3c7XG4gICAgfVxuICAgIGlmIChzYW1lSW5kZW50ICYmICFibGFuayAmJiAhaXNFbmQpIHtcbiAgICAgIHJldHVybiBbZ2V0Um93cyhlZGl0b3IsIHByZXZpb3VzUm93LCByb3cpLCByb3ddO1xuICAgIH1cbiAgICBwcmV2aW91c1JvdyAtPSAxO1xuICB9XG4gIHJldHVybiBudWxsO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZmluZENvZGVCbG9jayhlZGl0b3I6IGF0b20kVGV4dEVkaXRvcikge1xuICBjb25zdCBzZWxlY3RlZFRleHQgPSBnZXRTZWxlY3RlZFRleHQoZWRpdG9yKTtcblxuICBpZiAoc2VsZWN0ZWRUZXh0KSB7XG4gICAgY29uc3Qgc2VsZWN0ZWRSYW5nZSA9IGVkaXRvci5nZXRTZWxlY3RlZEJ1ZmZlclJhbmdlKCk7XG4gICAgbGV0IGVuZFJvdyA9IHNlbGVjdGVkUmFuZ2UuZW5kLnJvdztcbiAgICBpZiAoc2VsZWN0ZWRSYW5nZS5lbmQuY29sdW1uID09PSAwKSB7XG4gICAgICBlbmRSb3cgLT0gMTtcbiAgICB9XG4gICAgZW5kUm93ID0gZXNjYXBlQmxhbmtSb3dzKGVkaXRvciwgc2VsZWN0ZWRSYW5nZS5zdGFydC5yb3csIGVuZFJvdyk7XG4gICAgcmV0dXJuIFtzZWxlY3RlZFRleHQsIGVuZFJvd107XG4gIH1cblxuICBjb25zdCBjdXJzb3IgPSBlZGl0b3IuZ2V0TGFzdEN1cnNvcigpO1xuXG4gIGNvbnN0IHJvdyA9IGN1cnNvci5nZXRCdWZmZXJSb3coKTtcbiAgbG9nKFwiZmluZENvZGVCbG9jazpcIiwgcm93KTtcblxuICBjb25zdCBpbmRlbnRMZXZlbCA9IGN1cnNvci5nZXRJbmRlbnRMZXZlbCgpO1xuICBsZXQgZm9sZGFibGUgPSBlZGl0b3IuaXNGb2xkYWJsZUF0QnVmZmVyUm93KHJvdyk7XG4gIGNvbnN0IGZvbGRSYW5nZSA9IHJvd1JhbmdlRm9yQ29kZUZvbGRBdEJ1ZmZlclJvdyhlZGl0b3IsIHJvdyk7XG4gIGlmICghZm9sZFJhbmdlIHx8IGZvbGRSYW5nZVswXSA9PSBudWxsIHx8IGZvbGRSYW5nZVsxXSA9PSBudWxsKSB7XG4gICAgZm9sZGFibGUgPSBmYWxzZTtcbiAgfVxuXG4gIGlmIChmb2xkYWJsZSkge1xuICAgIHJldHVybiBnZXRGb2xkQ29udGVudHMoZWRpdG9yLCByb3cpO1xuICB9XG4gIGlmIChpc0JsYW5rKGVkaXRvciwgcm93KSB8fCBnZXRSb3coZWRpdG9yLCByb3cpID09PSBcImVuZFwiKSB7XG4gICAgcmV0dXJuIGZpbmRQcmVjZWRpbmdCbG9jayhlZGl0b3IsIHJvdywgaW5kZW50TGV2ZWwpO1xuICB9XG4gIHJldHVybiBbZ2V0Um93KGVkaXRvciwgcm93KSwgcm93XTtcbn1cbiJdfQ==