Object.defineProperty(exports, '__esModule', {
	value: true
});

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { 'default': obj }; }

/** @babel */

var _commandsGenerate = require('./commands/generate');

var _commandsGenerate2 = _interopRequireDefault(_commandsGenerate);

var _commandsShow = require('./commands/show');

var _commandsShow2 = _interopRequireDefault(_commandsShow);

var _commandsFix = require('./commands/fix');

var _commandsFix2 = _interopRequireDefault(_commandsFix);

var lazyReq = require('lazy-req')(require);

var atm = lazyReq('atom');

var checklist = lazyReq('./lib/checklist');
var wrapGuideInterceptor = lazyReq('./lib/wrapguide-interceptor');
var statusTile = lazyReq('./lib/statustile-view');
var editorconfig = lazyReq('editorconfig');

// Sets the state of the embedded editorconfig
// This includes the severity (info, warning..) as well as the notification-messages for users
function setState(ecfg) {
	checklist()(ecfg);
	statusTile().updateIcon(ecfg.state);
}

// Initializes the (into the TextBuffer-instance) embedded editorconfig-object
function initializeTextBuffer(buffer) {
	if ('editorconfig' in buffer === false) {
		buffer.editorconfig = {
			buffer: buffer, // preserving a reference to the parent TextBuffer
			disposables: new (atm().CompositeDisposable)(),
			state: 'subtle',
			settings: {
				trim_trailing_whitespace: 'auto', // eslint-disable-line camelcase
				insert_final_newline: 'auto', // eslint-disable-line camelcase
				max_line_length: 'auto', // eslint-disable-line camelcase
				end_of_line: 'auto', // eslint-disable-line camelcase
				indent_style: 'auto', // eslint-disable-line camelcase
				tab_width: 'auto', // eslint-disable-line camelcase
				charset: 'auto' // eslint-disable-line camelcase
			},

			// Get the current Editor for this.buffer
			getCurrentEditor: function getCurrentEditor() {
				var _this = this;

				return atom.workspace.getTextEditors().reduce(function (prev, curr) {
					return curr.getBuffer() === _this.buffer && curr || prev;
				}, undefined);
			},

			// Applies the settings to the buffer and the corresponding editor
			applySettings: function applySettings() {
				var editor = this.getCurrentEditor();
				if (!editor) {
					return;
				}
				var configOptions = { scope: editor.getRootScopeDescriptor() };
				var settings = this.settings;

				if (editor && editor.getBuffer() === buffer) {
					if (settings.indent_style === 'auto') {
						var usesSoftTabs = editor.usesSoftTabs();
						if (usesSoftTabs === undefined) {
							editor.setSoftTabs(atom.config.get('editor.softTabs', configOptions));
						} else {
							editor.setSoftTabs(usesSoftTabs);
						}
					} else {
						editor.setSoftTabs(settings.indent_style === 'space');
					}

					if (settings.tab_width === 'auto') {
						editor.setTabLength(atom.config.get('editor.tabLength', configOptions));
					} else {
						editor.setTabLength(settings.tab_width);
					}

					if (settings.charset === 'auto') {
						buffer.setEncoding(atom.config.get('core.fileEncoding', configOptions));
					} else {
						buffer.setEncoding(settings.charset);
					}

					// max_line_length-settings
					var editorParams = {};
					if (settings.max_line_length === 'auto') {
						editorParams.preferredLineLength = atom.config.get('editor.preferredLineLength', configOptions);
					} else {
						editorParams.preferredLineLength = settings.max_line_length;
					}

					// Update the editor-properties
					editor.update(editorParams);

					// Ensure the wrap-guide is being intercepted
					var bufferDom = atom.views.getView(editor);
					var wrapGuide = bufferDom.querySelector('* /deep/ .wrap-guide');
					if (wrapGuide !== null) {
						if (wrapGuide.editorconfig === undefined) {
							wrapGuide.editorconfig = this;
							wrapGuide.getNativeGuideColumn = wrapGuide.getGuideColumn;
							wrapGuide.getGuideColumn = wrapGuideInterceptor().getGuideColumn.bind(wrapGuide);
						}
						wrapGuide.updateGuide();
					}

					if (settings.end_of_line !== 'auto') {
						buffer.setPreferredLineEnding(settings.end_of_line);
					}
				}
				setState(this);
			},

			// onWillSave-Event-Handler
			// Trims whitespaces and inserts/strips final newline before saving
			onWillSave: function onWillSave() {
				var settings = this.settings;

				if (settings.trim_trailing_whitespace === true) {
					// eslint-disable-next-line max-params
					buffer.backwardsScan(/[ \t]+$/gm, function (params) {
						if (params.match[0].length > 0) {
							params.replace('');
						}
					});
				}

				if (settings.insert_final_newline !== 'auto') {
					var lastRow = buffer.getLineCount() - 1;

					if (buffer.isRowBlank(lastRow)) {
						var stripStart = buffer.previousNonBlankRow(lastRow);

						if (settings.insert_final_newline === true) {
							stripStart += 1;
						}
						// Strip empty lines from the end
						if (stripStart < lastRow) {
							buffer.deleteRows(stripStart + 1, lastRow);
						}
					} else if (settings.insert_final_newline === true) {
						buffer.append('\n');
					}
				}
			}
		};

		buffer.editorconfig.disposables.add(buffer.onWillSave(buffer.editorconfig.onWillSave.bind(buffer.editorconfig)));
		if (buffer.getUri() && buffer.getUri().match(/[\\|/]\.editorconfig$/g) !== null) {
			buffer.editorconfig.disposables.add(buffer.onDidSave(reapplyEditorconfig));
		}
	}
}

// Reveal and apply the editorconfig for the given TextEditor-instance
function observeTextEditor(editor) {
	if (!editor) {
		return;
	}
	initializeTextBuffer(editor.getBuffer());

	var file = editor.getURI();
	if (!file) {
		editor.onDidSave(function () {
			observeTextEditor(editor);
		});
		return;
	}

	editorconfig().parse(file).then(function (config) {
		if (Object.keys(config).length === 0) {
			return;
		}

		var ecfg = editor.getBuffer().editorconfig;
		var settings = ecfg.settings;
		var lineEndings = {
			crlf: '\r\n',
			cr: '\r',
			lf: '\n'
		};

		// Preserve evaluated Editorconfig
		ecfg.config = config;

		// Carefully normalize and initialize config-settings
		// eslint-disable-next-line camelcase
		settings.trim_trailing_whitespace = 'trim_trailing_whitespace' in config && typeof config.trim_trailing_whitespace === 'boolean' ? config.trim_trailing_whitespace === true : 'auto';

		// eslint-disable-next-line camelcase
		settings.insert_final_newline = 'insert_final_newline' in config && typeof config.insert_final_newline === 'boolean' ? config.insert_final_newline === true : 'auto';

		// eslint-disable-next-line camelcase
		settings.indent_style = 'indent_style' in config && config.indent_style.search(/^(space|tab)$/) > -1 ? config.indent_style : 'auto';

		// eslint-disable-next-line camelcase
		settings.end_of_line = lineEndings[config.end_of_line] || 'auto';

		// eslint-disable-next-line camelcase
		settings.tab_width = parseInt(config.indent_size || config.tab_width, 10);
		if (isNaN(settings.tab_width) || settings.tab_width <= 0) {
			settings.tab_width = 'auto'; // eslint-disable-line camelcase
		}

		// eslint-disable-next-line camelcase
		settings.max_line_length = parseInt(config.max_line_length, 10);
		if (isNaN(settings.max_line_length) || settings.max_line_length <= 0) {
			settings.max_line_length = 'auto'; // eslint-disable-line camelcase
		}

		settings.charset = 'charset' in config ? config.charset.replace(/-/g, '').toLowerCase() : 'auto';

		ecfg.applySettings();
	})['catch'](Error, function (e) {
		console.warn('atom-editorconfig: ' + e);
	});
}

// Reapplies the whole editorconfig to **all** open TextEditor-instances
function reapplyEditorconfig() {
	var textEditors = atom.workspace.getTextEditors();
	textEditors.forEach(function (editor) {
		observeTextEditor(editor);
	});
}

// Reapplies the settings immediately after changing the focus to a new pane
function observeActivePaneItem(editor) {
	if (editor && editor.constructor.name === 'TextEditor') {
		if (editor.getBuffer().editorconfig) {
			editor.getBuffer().editorconfig.applySettings();
		}
	} else {
		statusTile().removeIcon();
	}
}

// Hook into the events to recognize the user opening new editors or changing the pane
var activate = function activate() {
	(0, _commandsGenerate2['default'])();
	(0, _commandsShow2['default'])();
	(0, _commandsFix2['default'])();
	atom.workspace.observeTextEditors(observeTextEditor);
	atom.workspace.observeActivePaneItem(observeActivePaneItem);
	reapplyEditorconfig();
};

// Clean the status-icon up, remove all embedded editorconfig-objects
var deactivate = function deactivate() {
	var textEditors = atom.workspace.getTextEditors();
	textEditors.forEach(function (editor) {
		editor.getBuffer().editorconfig.disposables.dispose();
	});
	statusTile().removeIcon();
};

// Apply the statusbar icon-container
// The icon will be applied if needed
var consumeStatusBar = function consumeStatusBar(statusBar) {
	if (statusTile().containerExists() === false) {
		statusBar.addRightTile({
			item: statusTile().createContainer(),
			priority: 999
		});
	}
};

exports['default'] = { activate: activate, deactivate: deactivate, consumeStatusBar: consumeStatusBar };
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9Vc2Vycy9ldmFuaGVuZHJpeDEvLmF0b20vcGFja2FnZXMvZWRpdG9yY29uZmlnL2luZGV4LmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7O2dDQUMyQixxQkFBcUI7Ozs7NEJBQzFCLGlCQUFpQjs7OzsyQkFDbkIsZ0JBQWdCOzs7O0FBRXBDLElBQU0sT0FBTyxHQUFHLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQzs7QUFFN0MsSUFBTSxHQUFHLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDOztBQUU1QixJQUFNLFNBQVMsR0FBRyxPQUFPLENBQUMsaUJBQWlCLENBQUMsQ0FBQztBQUM3QyxJQUFNLG9CQUFvQixHQUFHLE9BQU8sQ0FBQyw2QkFBNkIsQ0FBQyxDQUFDO0FBQ3BFLElBQU0sVUFBVSxHQUFHLE9BQU8sQ0FBQyx1QkFBdUIsQ0FBQyxDQUFDO0FBQ3BELElBQU0sWUFBWSxHQUFHLE9BQU8sQ0FBQyxjQUFjLENBQUMsQ0FBQzs7OztBQUk3QyxTQUFTLFFBQVEsQ0FBQyxJQUFJLEVBQUU7QUFDdkIsVUFBUyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDbEIsV0FBVSxFQUFFLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztDQUNwQzs7O0FBR0QsU0FBUyxvQkFBb0IsQ0FBQyxNQUFNLEVBQUU7QUFDckMsS0FBSSxjQUFjLElBQUksTUFBTSxLQUFLLEtBQUssRUFBRTtBQUN2QyxRQUFNLENBQUMsWUFBWSxHQUFHO0FBQ3JCLFNBQU0sRUFBTixNQUFNO0FBQ04sY0FBVyxFQUFFLEtBQUssR0FBRyxFQUFFLENBQUMsbUJBQW1CLENBQUEsRUFBRztBQUM5QyxRQUFLLEVBQUUsUUFBUTtBQUNmLFdBQVEsRUFBRTtBQUNULDRCQUF3QixFQUFFLE1BQU07QUFDaEMsd0JBQW9CLEVBQUUsTUFBTTtBQUM1QixtQkFBZSxFQUFFLE1BQU07QUFDdkIsZUFBVyxFQUFFLE1BQU07QUFD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QyIsImZpbGUiOiIvVXNlcnMvZXZhbmhlbmRyaXgxLy5hdG9tL3BhY2thZ2VzL2VkaXRvcmNvbmZpZy9pbmRleC5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qKiBAYmFiZWwgKi9cbmltcG9ydCBnZW5lcmF0ZUNvbmZpZyBmcm9tICcuL2NvbW1hbmRzL2dlbmVyYXRlJztcbmltcG9ydCBzaG93U3RhdGUgZnJvbSAnLi9jb21tYW5kcy9zaG93JztcbmltcG9ydCBmaXhGaWxlIGZyb20gJy4vY29tbWFuZHMvZml4JztcblxuY29uc3QgbGF6eVJlcSA9IHJlcXVpcmUoJ2xhenktcmVxJykocmVxdWlyZSk7XG5cbmNvbnN0IGF0bSA9IGxhenlSZXEoJ2F0b20nKTtcblxuY29uc3QgY2hlY2tsaXN0ID0gbGF6eVJlcSgnLi9saWIvY2hlY2tsaXN0Jyk7XG5jb25zdCB3cmFwR3VpZGVJbnRlcmNlcHRvciA9IGxhenlSZXEoJy4vbGliL3dyYXBndWlkZS1pbnRlcmNlcHRvcicpO1xuY29uc3Qgc3RhdHVzVGlsZSA9IGxhenlSZXEoJy4vbGliL3N0YXR1c3RpbGUtdmlldycpO1xuY29uc3QgZWRpdG9yY29uZmlnID0gbGF6eVJlcSgnZWRpdG9yY29uZmlnJyk7XG5cbi8vIFNldHMgdGhlIHN0YXRlIG9mIHRoZSBlbWJlZGRlZCBlZGl0b3Jjb25maWdcbi8vIFRoaXMgaW5jbHVkZXMgdGhlIHNldmVyaXR5IChpbmZvLCB3YXJuaW5nLi4pIGFzIHdlbGwgYXMgdGhlIG5vdGlmaWNhdGlvbi1tZXNzYWdlcyBmb3IgdXNlcnNcbmZ1bmN0aW9uIHNldFN0YXRlKGVjZmcpIHtcblx0Y2hlY2tsaXN0KCkoZWNmZyk7XG5cdHN0YXR1c1RpbGUoKS51cGRhdGVJY29uKGVjZmcuc3RhdGUpO1xufVxuXG4vLyBJbml0aWFsaXplcyB0aGUgKGludG8gdGhlIFRleHRCdWZmZXItaW5zdGFuY2UpIGVtYmVkZGVkIGVkaXRvcmNvbmZpZy1vYmplY3RcbmZ1bmN0aW9uIGluaXRpYWxpemVUZXh0QnVmZmVyKGJ1ZmZlcikge1xuXHRpZiAoJ2VkaXRvcmNvbmZpZycgaW4gYnVmZmVyID09PSBmYWxzZSkge1xuXHRcdGJ1ZmZlci5lZGl0b3Jjb25maWcgPSB7XG5cdFx0XHRidWZmZXIsIC8vIHByZXNlcnZpbmcgYSByZWZlcmVuY2UgdG8gdGhlIHBhcmVudCBUZXh0QnVmZmVyXG5cdFx0XHRkaXNwb3NhYmxlczogbmV3IChhdG0oKS5Db21wb3NpdGVEaXNwb3NhYmxlKSgpLFxuXHRcdFx0c3RhdGU6ICdzdWJ0bGUnLFxuXHRcdFx0c2V0dGluZ3M6IHtcblx0XHRcdFx0dHJpbV90cmFpbGluZ193aGl0ZXNwYWNlOiAnYXV0bycsIC8vIGVzbGludC1kaXNhYmxlLWxpbmUgY2FtZWxjYXNlXG5cdFx0XHRcdGluc2VydF9maW5hbF9uZXdsaW5lOiAnYXV0bycsIC8vIGVzbGludC1kaXNhYmxlLWxpbmUgY2FtZWxjYXNlXG5cdFx0XHRcdG1heF9saW5lX2xlbmd0aDogJ2F1dG8nLCAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIGNhbWVsY2FzZVxuXHRcdFx0XHRlbmRfb2ZfbGluZTogJ2F1dG8nLCAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIGNhbWVsY2FzZVxuXHRcdFx0XHRpbmRlbnRfc3R5bGU6ICdhdXRvJywgLy8gZXNsaW50LWRpc2FibGUtbGluZSBjYW1lbGNhc2Vcblx0XHRcdFx0dGFiX3dpZHRoOiAnYXV0bycsIC8vIGVzbGludC1kaXNhYmxlLWxpbmUgY2FtZWxjYXNlXG5cdFx0XHRcdGNoYXJzZXQ6ICdhdXRvJyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIGNhbWVsY2FzZVxuXHRcdFx0fSxcblxuXHRcdFx0Ly8gR2V0IHRoZSBjdXJyZW50IEVkaXRvciBmb3IgdGhpcy5idWZmZXJcblx0XHRcdGdldEN1cnJlbnRFZGl0b3IoKSB7XG5cdFx0XHRcdHJldHVybiBhdG9tLndvcmtzcGFjZS5nZXRUZXh0RWRpdG9ycygpLnJlZHVjZSgocHJldiwgY3VycikgPT4ge1xuXHRcdFx0XHRcdHJldHVybiAoY3Vyci5nZXRCdWZmZXIoKSA9PT0gdGhpcy5idWZmZXIgJiYgY3VycikgfHwgcHJldjtcblx0XHRcdFx0fSwgdW5kZWZpbmVkKTtcblx0XHRcdH0sXG5cblx0XHRcdC8vIEFwcGxpZXMgdGhlIHNldHRpbmdzIHRvIHRoZSBidWZmZXIgYW5kIHRoZSBjb3JyZXNwb25kaW5nIGVkaXRvclxuXHRcdFx0YXBwbHlTZXR0aW5ncygpIHtcblx0XHRcdFx0Y29uc3QgZWRpdG9yID0gdGhpcy5nZXRDdXJyZW50RWRpdG9yKCk7XG5cdFx0XHRcdGlmICghZWRpdG9yKSB7XG5cdFx0XHRcdFx0cmV0dXJuO1xuXHRcdFx0XHR9XG5cdFx0XHRcdGNvbnN0IGNvbmZpZ09wdGlvbnMgPSB7c2NvcGU6IGVkaXRvci5nZXRSb290U2NvcGVEZXNjcmlwdG9yKCl9O1xuXHRcdFx0XHRjb25zdCBzZXR0aW5ncyA9IHRoaXMuc2V0dGluZ3M7XG5cblx0XHRcdFx0aWYgKGVkaXRvciAmJiBlZGl0b3IuZ2V0QnVmZmVyKCkgPT09IGJ1ZmZlcikge1xuXHRcdFx0XHRcdGlmIChzZXR0aW5ncy5pbmRlbnRfc3R5bGUgPT09ICdhdXRvJykge1xuXHRcdFx0XHRcdFx0Y29uc3QgdXNlc1NvZnRUYWJzID0gZWRpdG9yLnVzZXNTb2Z0VGFicygpO1xuXHRcdFx0XHRcdFx0aWYgKHVzZXNTb2Z0VGFicyA9PT0gdW5kZWZpbmVkKSB7XG5cdFx0XHRcdFx0XHRcdGVkaXRvci5zZXRTb2Z0VGFicyhhdG9tLmNvbmZpZy5nZXQoJ2VkaXRvci5zb2Z0VGFicycsIGNvbmZpZ09wdGlvbnMpKTtcblx0XHRcdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0XHRcdGVkaXRvci5zZXRTb2Z0VGFicyh1c2VzU29mdFRhYnMpO1xuXHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0XHRlZGl0b3Iuc2V0U29mdFRhYnMoc2V0dGluZ3MuaW5kZW50X3N0eWxlID09PSAnc3BhY2UnKTtcblx0XHRcdFx0XHR9XG5cblx0XHRcdFx0XHRpZiAoc2V0dGluZ3MudGFiX3dpZHRoID09PSAnYXV0bycpIHtcblx0XHRcdFx0XHRcdGVkaXRvci5zZXRUYWJMZW5ndGgoYXRvbS5jb25maWcuZ2V0KCdlZGl0b3IudGFiTGVuZ3RoJywgY29uZmlnT3B0aW9ucykpO1xuXHRcdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0XHRlZGl0b3Iuc2V0VGFiTGVuZ3RoKHNldHRpbmdzLnRhYl93aWR0aCk7XG5cdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0aWYgKHNldHRpbmdzLmNoYXJzZXQgPT09ICdhdXRvJykge1xuXHRcdFx0XHRcdFx0YnVmZmVyLnNldEVuY29kaW5nKGF0b20uY29uZmlnLmdldCgnY29yZS5maWxlRW5jb2RpbmcnLCBjb25maWdPcHRpb25zKSk7XG5cdFx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHRcdGJ1ZmZlci5zZXRFbmNvZGluZyhzZXR0aW5ncy5jaGFyc2V0KTtcblx0XHRcdFx0XHR9XG5cblx0XHRcdFx0XHQvLyBtYXhfbGluZV9sZW5ndGgtc2V0dGluZ3Ncblx0XHRcdFx0XHRjb25zdCBlZGl0b3JQYXJhbXMgPSB7fTtcblx0XHRcdFx0XHRpZiAoc2V0dGluZ3MubWF4X2xpbmVfbGVuZ3RoID09PSAnYXV0bycpIHtcblx0XHRcdFx0XHRcdGVkaXRvclBhcmFtcy5wcmVmZXJyZWRMaW5lTGVuZ3RoID1cblx0XHRcdFx0XHRcdFx0YXRvbS5jb25maWcuZ2V0KCdlZGl0b3IucHJlZmVycmVkTGluZUxlbmd0aCcsIGNvbmZpZ09wdGlvbnMpO1xuXHRcdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0XHRlZGl0b3JQYXJhbXMucHJlZmVycmVkTGluZUxlbmd0aCA9IHNldHRpbmdzLm1heF9saW5lX2xlbmd0aDtcblx0XHRcdFx0XHR9XG5cblx0XHRcdFx0XHQvLyBVcGRhdGUgdGhlIGVkaXRvci1wcm9wZXJ0aWVzXG5cdFx0XHRcdFx0ZWRpdG9yLnVwZGF0ZShlZGl0b3JQYXJhbXMpO1xuXG5cdFx0XHRcdFx0Ly8gRW5zdXJlIHRoZSB3cmFwLWd1aWRlIGlzIGJlaW5nIGludGVyY2VwdGVkXG5cdFx0XHRcdFx0Y29uc3QgYnVmZmVyRG9tID0gYXRvbS52aWV3cy5nZXRWaWV3KGVkaXRvcik7XG5cdFx0XHRcdFx0Y29uc3Qgd3JhcEd1aWRlID0gYnVmZmVyRG9tLnF1ZXJ5U2VsZWN0b3IoJyogL2RlZXAvIC53cmFwLWd1aWRlJyk7XG5cdFx0XHRcdFx0aWYgKHdyYXBHdWlkZSAhPT0gbnVsbCkge1xuXHRcdFx0XHRcdFx0aWYgKHdyYXBHdWlkZS5lZGl0b3Jjb25maWcgPT09IHVuZGVmaW5lZCkge1xuXHRcdFx0XHRcdFx0XHR3cmFwR3VpZGUuZWRpdG9yY29uZmlnID0gdGhpcztcblx0XHRcdFx0XHRcdFx0d3JhcEd1aWRlLmdldE5hdGl2ZUd1aWRlQ29sdW1uID0gd3JhcEd1aWRlLmdldEd1aWRlQ29sdW1uO1xuXHRcdFx0XHRcdFx0XHR3cmFwR3VpZGUuZ2V0R3VpZGVDb2x1bW4gPSB3cmFwR3VpZGVJbnRlcmNlcHRvcigpXG5cdFx0XHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0LmdldEd1aWRlQ29sdW1uXG5cdFx0XHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0LmJpbmQod3JhcEd1aWRlKTtcblx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcdHdyYXBHdWlkZS51cGRhdGVHdWlkZSgpO1xuXHRcdFx0XHRcdH1cblxuXHRcdFx0XHRcdGlmIChzZXR0aW5ncy5lbmRfb2ZfbGluZSAhPT0gJ2F1dG8nKSB7XG5cdFx0XHRcdFx0XHRidWZmZXIuc2V0UHJlZmVycmVkTGluZUVuZGluZyhzZXR0aW5ncy5lbmRfb2ZfbGluZSk7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHR9XG5cdFx0XHRcdHNldFN0YXRlKHRoaXMpO1xuXHRcdFx0fSxcblxuXHRcdFx0Ly8gb25XaWxsU2F2ZS1FdmVudC1IYW5kbGVyXG5cdFx0XHQvLyBUcmltcyB3aGl0ZXNwYWNlcyBhbmQgaW5zZXJ0cy9zdHJpcHMgZmluYWwgbmV3bGluZSBiZWZvcmUgc2F2aW5nXG5cdFx0XHRvbldpbGxTYXZlKCkge1xuXHRcdFx0XHRjb25zdCBzZXR0aW5ncyA9IHRoaXMuc2V0dGluZ3M7XG5cblx0XHRcdFx0aWYgKHNldHRpbmdzLnRyaW1fdHJhaWxpbmdfd2hpdGVzcGFjZSA9PT0gdHJ1ZSkge1xuXHRcdFx0XHRcdC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBtYXgtcGFyYW1zXG5cdFx0XHRcdFx0YnVmZmVyLmJhY2t3YXJkc1NjYW4oL1sgXFx0XSskL2dtLCBwYXJhbXMgPT4ge1xuXHRcdFx0XHRcdFx0aWYgKHBhcmFtcy5tYXRjaFswXS5sZW5ndGggPiAwKSB7XG5cdFx0XHRcdFx0XHRcdHBhcmFtcy5yZXBsYWNlKCcnKTtcblx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHR9KTtcblx0XHRcdFx0fVxuXG5cdFx0XHRcdGlmIChzZXR0aW5ncy5pbnNlcnRfZmluYWxfbmV3bGluZSAhPT0gJ2F1dG8nKSB7XG5cdFx0XHRcdFx0Y29uc3QgbGFzdFJvdyA9IGJ1ZmZlci5nZXRMaW5lQ291bnQoKSAtIDE7XG5cblx0XHRcdFx0XHRpZiAoYnVmZmVyLmlzUm93QmxhbmsobGFzdFJvdykpIHtcblx0XHRcdFx0XHRcdGxldCBzdHJpcFN0YXJ0ID0gYnVmZmVyLnByZXZpb3VzTm9uQmxhbmtSb3cobGFzdFJvdyk7XG5cblx0XHRcdFx0XHRcdGlmIChzZXR0aW5ncy5pbnNlcnRfZmluYWxfbmV3bGluZSA9PT0gdHJ1ZSkge1xuXHRcdFx0XHRcdFx0XHRzdHJpcFN0YXJ0ICs9IDE7XG5cdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0XHQvLyBTdHJpcCBlbXB0eSBsaW5lcyBmcm9tIHRoZSBlbmRcblx0XHRcdFx0XHRcdGlmIChzdHJpcFN0YXJ0IDwgbGFzdFJvdykge1xuXHRcdFx0XHRcdFx0XHRidWZmZXIuZGVsZXRlUm93cyhzdHJpcFN0YXJ0ICsgMSwgbGFzdFJvdyk7XG5cdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0fSBlbHNlIGlmIChzZXR0aW5ncy5pbnNlcnRfZmluYWxfbmV3bGluZSA9PT0gdHJ1ZSkge1xuXHRcdFx0XHRcdFx0YnVmZmVyLmFwcGVuZCgnXFxuJyk7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHR9XG5cdFx0XHR9XG5cdFx0fTtcblxuXHRcdGJ1ZmZlci5lZGl0b3Jjb25maWcuZGlzcG9zYWJsZXMuYWRkKFxuXHRcdFx0YnVmZmVyLm9uV2lsbFNhdmUoYnVmZmVyLmVkaXRvcmNvbmZpZy5vbldpbGxTYXZlLmJpbmQoYnVmZmVyLmVkaXRvcmNvbmZpZykpXG5cdFx0KTtcblx0XHRpZiAoYnVmZmVyLmdldFVyaSgpICYmIGJ1ZmZlci5nZXRVcmkoKS5tYXRjaCgvW1xcXFx8L11cXC5lZGl0b3Jjb25maWckL2cpICE9PSBudWxsKSB7XG5cdFx0XHRidWZmZXIuZWRpdG9yY29uZmlnLmRpc3Bvc2FibGVzLmFkZChcblx0XHRcdFx0YnVmZmVyLm9uRGlkU2F2ZShyZWFwcGx5RWRpdG9yY29uZmlnKVxuXHRcdFx0KTtcblx0XHR9XG5cdH1cbn1cblxuLy8gUmV2ZWFsIGFuZCBhcHBseSB0aGUgZWRpdG9yY29uZmlnIGZvciB0aGUgZ2l2ZW4gVGV4dEVkaXRvci1pbnN0YW5jZVxuZnVuY3Rpb24gb2JzZXJ2ZVRleHRFZGl0b3IoZWRpdG9yKSB7XG5cdGlmICghZWRpdG9yKSB7XG5cdFx0cmV0dXJuO1xuXHR9XG5cdGluaXRpYWxpemVUZXh0QnVmZmVyKGVkaXRvci5nZXRCdWZmZXIoKSk7XG5cblx0Y29uc3QgZmlsZSA9IGVkaXRvci5nZXRVUkkoKTtcblx0aWYgKCFmaWxlKSB7XG5cdFx0ZWRpdG9yLm9uRGlkU2F2ZSgoKSA9PiB7XG5cdFx0XHRvYnNlcnZlVGV4dEVkaXRvcihlZGl0b3IpO1xuXHRcdH0pO1xuXHRcdHJldHVybjtcblx0fVxuXG5cdGVkaXRvcmNvbmZpZygpLnBhcnNlKGZpbGUpLnRoZW4oY29uZmlnID0+IHtcblx0XHRpZiAoT2JqZWN0LmtleXMoY29uZmlnKS5sZW5ndGggPT09IDApIHtcblx0XHRcdHJldHVybjtcblx0XHR9XG5cblx0XHRjb25zdCBlY2ZnID0gZWRpdG9yLmdldEJ1ZmZlcigpLmVkaXRvcmNvbmZpZztcblx0XHRjb25zdCBzZXR0aW5ncyA9IGVjZmcuc2V0dGluZ3M7XG5cdFx0Y29uc3QgbGluZUVuZGluZ3MgPSB7XG5cdFx0XHRjcmxmOiAnXFxyXFxuJyxcblx0XHRcdGNyOiAnXFxyJyxcblx0XHRcdGxmOiAnXFxuJ1xuXHRcdH07XG5cblx0XHQvLyBQcmVzZXJ2ZSBldmFsdWF0ZWQgRWRpdG9yY29uZmlnXG5cdFx0ZWNmZy5jb25maWcgPSBjb25maWc7XG5cblx0XHQvLyBDYXJlZnVsbHkgbm9ybWFsaXplIGFuZCBpbml0aWFsaXplIGNvbmZpZy1zZXR0aW5nc1xuXHRcdC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBjYW1lbGNhc2Vcblx0XHRzZXR0aW5ncy50cmltX3RyYWlsaW5nX3doaXRlc3BhY2UgPSAoJ3RyaW1fdHJhaWxpbmdfd2hpdGVzcGFjZScgaW4gY29uZmlnKSAmJlxuXHRcdFx0dHlwZW9mIGNvbmZpZy50cmltX3RyYWlsaW5nX3doaXRlc3BhY2UgPT09ICdib29sZWFuJyA/XG5cdFx0XHRjb25maWcudHJpbV90cmFpbGluZ193aGl0ZXNwYWNlID09PSB0cnVlIDpcblx0XHRcdCdhdXRvJztcblxuXHRcdC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBjYW1lbGNhc2Vcblx0XHRzZXR0aW5ncy5pbnNlcnRfZmluYWxfbmV3bGluZSA9ICgnaW5zZXJ0X2ZpbmFsX25ld2xpbmUnIGluIGNvbmZpZykgJiZcblx0XHRcdHR5cGVvZiBjb25maWcuaW5zZXJ0X2ZpbmFsX25ld2xpbmUgPT09ICdib29sZWFuJyA/XG5cdFx0XHRjb25maWcuaW5zZXJ0X2ZpbmFsX25ld2xpbmUgPT09IHRydWUgOlxuXHRcdFx0J2F1dG8nO1xuXG5cdFx0Ly8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIGNhbWVsY2FzZVxuXHRcdHNldHRpbmdzLmluZGVudF9zdHlsZSA9ICgoJ2luZGVudF9zdHlsZScgaW4gY29uZmlnKSAmJlxuXHRcdFx0Y29uZmlnLmluZGVudF9zdHlsZS5zZWFyY2goL14oc3BhY2V8dGFiKSQvKSA+IC0xKSA/XG5cdFx0XHRjb25maWcuaW5kZW50X3N0eWxlIDpcblx0XHRcdCdhdXRvJztcblxuXHRcdC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBjYW1lbGNhc2Vcblx0XHRzZXR0aW5ncy5lbmRfb2ZfbGluZSA9IGxpbmVFbmRpbmdzW2NvbmZpZy5lbmRfb2ZfbGluZV0gfHwgJ2F1dG8nO1xuXG5cdFx0Ly8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIGNhbWVsY2FzZVxuXHRcdHNldHRpbmdzLnRhYl93aWR0aCA9IHBhcnNlSW50KGNvbmZpZy5pbmRlbnRfc2l6ZSB8fCBjb25maWcudGFiX3dpZHRoLCAxMCk7XG5cdFx0aWYgKGlzTmFOKHNldHRpbmdzLnRhYl93aWR0aCkgfHwgc2V0dGluZ3MudGFiX3dpZHRoIDw9IDApIHtcblx0XHRcdHNldHRpbmdzLnRhYl93aWR0aCA9ICdhdXRvJzsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBjYW1lbGNhc2Vcblx0XHR9XG5cblx0XHQvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgY2FtZWxjYXNlXG5cdFx0c2V0dGluZ3MubWF4X2xpbmVfbGVuZ3RoID0gcGFyc2VJbnQoY29uZmlnLm1heF9saW5lX2xlbmd0aCwgMTApO1xuXHRcdGlmIChpc05hTihzZXR0aW5ncy5tYXhfbGluZV9sZW5ndGgpIHx8IHNldHRpbmdzLm1heF9saW5lX2xlbmd0aCA8PSAwKSB7XG5cdFx0XHRzZXR0aW5ncy5tYXhfbGluZV9sZW5ndGggPSAnYXV0byc7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgY2FtZWxjYXNlXG5cdFx0fVxuXG5cdFx0c2V0dGluZ3MuY2hhcnNldCA9ICgnY2hhcnNldCcgaW4gY29uZmlnKSA/XG5cdFx0XHRjb25maWcuY2hhcnNldC5yZXBsYWNlKC8tL2csICcnKS50b0xvd2VyQ2FzZSgpIDpcblx0XHRcdCdhdXRvJztcblxuXHRcdGVjZmcuYXBwbHlTZXR0aW5ncygpO1xuXHR9KS5jYXRjaChFcnJvciwgZSA9PiB7XG5cdFx0Y29uc29sZS53YXJuKGBhdG9tLWVkaXRvcmNvbmZpZzogJHtlfWApO1xuXHR9KTtcbn1cblxuLy8gUmVhcHBsaWVzIHRoZSB3aG9sZSBlZGl0b3Jjb25maWcgdG8gKiphbGwqKiBvcGVuIFRleHRFZGl0b3ItaW5zdGFuY2VzXG5mdW5jdGlvbiByZWFwcGx5RWRpdG9yY29uZmlnKCkge1xuXHRjb25zdCB0ZXh0RWRpdG9ycyA9IGF0b20ud29ya3NwYWNlLmdldFRleHRFZGl0b3JzKCk7XG5cdHRleHRFZGl0b3JzLmZvckVhY2goZWRpdG9yID0+IHtcblx0XHRvYnNlcnZlVGV4dEVkaXRvcihlZGl0b3IpO1xuXHR9KTtcbn1cblxuLy8gUmVhcHBsaWVzIHRoZSBzZXR0aW5ncyBpbW1lZGlhdGVseSBhZnRlciBjaGFuZ2luZyB0aGUgZm9jdXMgdG8gYSBuZXcgcGFuZVxuZnVuY3Rpb24gb2JzZXJ2ZUFjdGl2ZVBhbmVJdGVtKGVkaXRvcikge1xuXHRpZiAoZWRpdG9yICYmIGVkaXRvci5jb25zdHJ1Y3Rvci5uYW1lID09PSAnVGV4dEVkaXRvcicpIHtcblx0XHRpZiAoZWRpdG9yLmdldEJ1ZmZlcigpLmVkaXRvcmNvbmZpZykge1xuXHRcdFx0ZWRpdG9yLmdldEJ1ZmZlcigpLmVkaXRvcmNvbmZpZy5hcHBseVNldHRpbmdzKCk7XG5cdFx0fVxuXHR9IGVsc2Uge1xuXHRcdHN0YXR1c1RpbGUoKS5yZW1vdmVJY29uKCk7XG5cdH1cbn1cblxuLy8gSG9vayBpbnRvIHRoZSBldmVudHMgdG8gcmVjb2duaXplIHRoZSB1c2VyIG9wZW5pbmcgbmV3IGVkaXRvcnMgb3IgY2hhbmdpbmcgdGhlIHBhbmVcbmNvbnN0IGFjdGl2YXRlID0gKCkgPT4ge1xuXHRnZW5lcmF0ZUNvbmZpZygpO1xuXHRzaG93U3RhdGUoKTtcblx0Zml4RmlsZSgpO1xuXHRhdG9tLndvcmtzcGFjZS5vYnNlcnZlVGV4dEVkaXRvcnMob2JzZXJ2ZVRleHRFZGl0b3IpO1xuXHRhdG9tLndvcmtzcGFjZS5vYnNlcnZlQWN0aXZlUGFuZUl0ZW0ob2JzZXJ2ZUFjdGl2ZVBhbmVJdGVtKTtcblx0cmVhcHBseUVkaXRvcmNvbmZpZygpO1xufTtcblxuLy8gQ2xlYW4gdGhlIHN0YXR1cy1pY29uIHVwLCByZW1vdmUgYWxsIGVtYmVkZGVkIGVkaXRvcmNvbmZpZy1vYmplY3RzXG5jb25zdCBkZWFjdGl2YXRlID0gKCkgPT4ge1xuXHRjb25zdCB0ZXh0RWRpdG9ycyA9IGF0b20ud29ya3NwYWNlLmdldFRleHRFZGl0b3JzKCk7XG5cdHRleHRFZGl0b3JzLmZvckVhY2goZWRpdG9yID0+IHtcblx0XHRlZGl0b3IuZ2V0QnVmZmVyKCkuZWRpdG9yY29uZmlnLmRpc3Bvc2FibGVzLmRpc3Bvc2UoKTtcblx0fSk7XG5cdHN0YXR1c1RpbGUoKS5yZW1vdmVJY29uKCk7XG59O1xuXG4vLyBBcHBseSB0aGUgc3RhdHVzYmFyIGljb24tY29udGFpbmVyXG4vLyBUaGUgaWNvbiB3aWxsIGJlIGFwcGxpZWQgaWYgbmVlZGVkXG5jb25zdCBjb25zdW1lU3RhdHVzQmFyID0gc3RhdHVzQmFyID0+IHtcblx0aWYgKHN0YXR1c1RpbGUoKS5jb250YWluZXJFeGlzdHMoKSA9PT0gZmFsc2UpIHtcblx0XHRzdGF0dXNCYXIuYWRkUmlnaHRUaWxlKHtcblx0XHRcdGl0ZW06IHN0YXR1c1RpbGUoKS5jcmVhdGVDb250YWluZXIoKSxcblx0XHRcdHByaW9yaXR5OiA5OTlcblx0XHR9KTtcblx0fVxufTtcblxuZXhwb3J0IGRlZmF1bHQge2FjdGl2YXRlLCBkZWFjdGl2YXRlLCBjb25zdW1lU3RhdHVzQmFyfTtcbiJdfQ==