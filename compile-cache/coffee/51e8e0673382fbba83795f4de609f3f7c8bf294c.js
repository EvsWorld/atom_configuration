(function() {
  module.exports = function(colorPicker) {
    return {
      Emitter: (require('../modules/Emitter'))(),
      element: null,
      color: null,
      emitOutputFormat: function(format) {
        return this.Emitter.emit('outputFormat', format);
      },
      onOutputFormat: function(callback) {
        return this.Emitter.on('outputFormat', callback);
      },
      activate: function() {
        var _isClicking, hasChild;
        this.element = {
          el: (function() {
            var _classPrefix, _el;
            _classPrefix = colorPicker.element.el.className;
            _el = document.createElement('div');
            _el.classList.add(_classPrefix + "-color");
            return _el;
          })(),
          addClass: function(className) {
            this.el.classList.add(className);
            return this;
          },
          removeClass: function(className) {
            this.el.classList.remove(className);
            return this;
          },
          height: function() {
            return this.el.offsetHeight;
          },
          add: function(element) {
            this.el.appendChild(element);
            return this;
          },
          previousColor: null,
          setColor: function(smartColor) {
            var _color;
            _color = smartColor.toRGBA();
            if (this.previousColor && this.previousColor === _color) {
              return;
            }
            this.el.style.backgroundColor = _color;
            return this.previousColor = _color;
          }
        };
        colorPicker.element.add(this.element.el);
        setTimeout((function(_this) {
          return function() {
            var _newHeight;
            _newHeight = colorPicker.element.height() + _this.element.height();
            return colorPicker.element.setHeight(_newHeight);
          };
        })(this));
        hasChild = function(element, child) {
          var _parent;
          if (child && (_parent = child.parentNode)) {
            if (child === element) {
              return true;
            } else {
              return hasChild(element, _parent);
            }
          }
          return false;
        };
        _isClicking = false;
        colorPicker.onMouseDown((function(_this) {
          return function(e, isOnPicker) {
            if (!(isOnPicker && hasChild(_this.element.el, e.target))) {
              return;
            }
            e.preventDefault();
            return _isClicking = true;
          };
        })(this));
        colorPicker.onMouseMove(function(e) {
          return _isClicking = false;
        });
        colorPicker.onMouseUp((function(_this) {
          return function(e) {
            if (!_isClicking) {
              return;
            }
            colorPicker.replace(_this.color);
            return colorPicker.element.close();
          };
        })(this));
        colorPicker.onKeyDown((function(_this) {
          return function(e) {
            if (e.which !== 13) {
              return;
            }
            e.stopPropagation();
            return colorPicker.replace(_this.color);
          };
        })(this));
        setTimeout((function(_this) {
          return function() {
            var Alpha;
            Alpha = colorPicker.getExtension('Alpha');
            Alpha.onColorChanged(function(smartColor) {
              _this.element.setColor((function() {
                if (smartColor) {
                  return smartColor;
                } else {
                  return colorPicker.SmartColor.HEX('#f00');
                }
              })());
            });
          };
        })(this));
        setTimeout((function(_this) {
          return function() {
            var Alpha, Format, Return, _currentColor, _formatFormat, _inputColor, _text, setColor;
            Alpha = colorPicker.getExtension('Alpha');
            Return = colorPicker.getExtension('Return');
            Format = colorPicker.getExtension('Format');
            _text = document.createElement('p');
            _text.classList.add(_this.element.el.className + "-text");
            colorPicker.onBeforeOpen(function() {
              return _this.color = null;
            });
            _inputColor = null;
            colorPicker.onInputColor(function(smartColor, wasFound) {
              return _inputColor = wasFound ? smartColor : null;
            });
            _formatFormat = null;
            Format.onFormatChanged(function(format) {
              return _formatFormat = format;
            });
            colorPicker.onInputColor(function() {
              return _formatFormat = null;
            });
            setColor = function(smartColor) {
              var _format, _function, _outputColor, _preferredFormat;
              _preferredFormat = atom.config.get('color-picker.preferredFormat');
              _format = _formatFormat || (_inputColor != null ? _inputColor.format : void 0) || _preferredFormat || 'RGB';
              _function = smartColor.getAlpha() < 1 ? smartColor["to" + _format + "A"] || smartColor["to" + _format] : smartColor["to" + _format];
              _outputColor = (function() {
                if (_inputColor && (_inputColor.format === _format || _inputColor.format === (_format + "A"))) {
                  if (smartColor.equals(_inputColor)) {
                    return _inputColor.value;
                  }
                }
                return _function.call(smartColor);
              })();
              if (_outputColor === _this.color) {
                return;
              }
              if (_inputColor && atom.config.get('color-picker.automaticReplace')) {
                colorPicker.replace(_outputColor);
              }
              _this.color = _outputColor;
              _text.innerText = _outputColor;
              return _this.emitOutputFormat(_format);
            };
            _currentColor = null;
            Alpha.onColorChanged(function(smartColor) {
              setColor(_currentColor = (function() {
                if (smartColor) {
                  return smartColor;
                } else {
                  return colorPicker.SmartColor.HEX('#f00');
                }
              })());
            });
            Format.onFormatChanged(function() {
              return setColor(_currentColor);
            });
            Return.onVisibility(function(visibility) {
              if (visibility) {
                return _this.element.addClass('is--returnVisible');
              } else {
                return _this.element.removeClass('is--returnVisible');
              }
            });
            return _this.element.add(_text);
          };
        })(this));
        return this;
      }
    };
  };

}).call(this);

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiL1VzZXJzL2V2YW5oZW5kcml4MS8uYXRvbS9wYWNrYWdlcy9jb2xvci1waWNrZXIvbGliL2V4dGVuc2lvbnMvQ29sb3IuY29mZmVlIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUtJO0VBQUEsTUFBTSxDQUFDLE9BQVAsR0FBaUIsU0FBQyxXQUFEO1dBQ2I7TUFBQSxPQUFBLEVBQVMsQ0FBQyxPQUFBLENBQVEsb0JBQVIsQ0FBRCxDQUFBLENBQUEsQ0FBVDtNQUVBLE9BQUEsRUFBUyxJQUZUO01BR0EsS0FBQSxFQUFPLElBSFA7TUFTQSxnQkFBQSxFQUFrQixTQUFDLE1BQUQ7ZUFDZCxJQUFDLENBQUEsT0FBTyxDQUFDLElBQVQsQ0FBYyxjQUFkLEVBQThCLE1BQTlCO01BRGMsQ0FUbEI7TUFXQSxjQUFBLEVBQWdCLFNBQUMsUUFBRDtlQUNaLElBQUMsQ0FBQSxPQUFPLENBQUMsRUFBVCxDQUFZLGNBQVosRUFBNEIsUUFBNUI7TUFEWSxDQVhoQjtNQWlCQSxRQUFBLEVBQVUsU0FBQTtBQUNOLFlBQUE7UUFBQSxJQUFDLENBQUEsT0FBRCxHQUNJO1VBQUEsRUFBQSxFQUFPLENBQUEsU0FBQTtBQUNILGdCQUFBO1lBQUEsWUFBQSxHQUFlLFdBQVcsQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDO1lBQ3RDLEdBQUEsR0FBTSxRQUFRLENBQUMsYUFBVCxDQUF1QixLQUF2QjtZQUNOLEdBQUcsQ0FBQyxTQUFTLENBQUMsR0FBZCxDQUFzQixZQUFGLEdBQWdCLFFBQXBDO0FBRUEsbUJBQU87VUFMSixDQUFBLENBQUgsQ0FBQSxDQUFKO1VBT0EsUUFBQSxFQUFVLFNBQUMsU0FBRDtZQUFlLElBQUMsQ0FBQSxFQUFFLENBQUMsU0FBUyxDQUFDLEdBQWQsQ0FBa0IsU0FBbEI7QUFBNkIsbUJBQU87VUFBbkQsQ0FQVjtVQVFBLFdBQUEsRUFBYSxTQUFDLFNBQUQ7WUFBZSxJQUFDLENBQUEsRUFBRSxDQUFDLFNBQVMsQ0FB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U0FBQTtnQkFDeEIsSUFBRyxVQUFIO0FBQW1CLHlCQUFPLFdBQTFCO2lCQUFBLE1BQUE7QUFFSyx5QkFBTyxXQUFXLENBQUMsVUFBVSxDQUFDLEdBQXZCLENBQTJCLE1BQTNCLEVBRlo7O2NBRHdCLENBQUEsQ0FBSCxDQUFBLENBQXpCO1lBRGlCLENBQXJCO1lBUUEsTUFBTSxDQUFDLGVBQVAsQ0FBdUIsU0FBQTtxQkFBRyxRQUFBLENBQVMsYUFBVDtZQUFILENBQXZCO1lBSUEsTUFBTSxDQUFDLFlBQVAsQ0FBb0IsU0FBQyxVQUFEO2NBQ2hCLElBQUcsVUFBSDt1QkFBbUIsS0FBQyxDQUFBLE9BQU8sQ0FBQyxRQUFULENBQWtCLG1CQUFsQixFQUFuQjtlQUFBLE1BQUE7dUJBQ0ssS0FBQyxDQUFBLE9BQU8sQ0FBQyxXQUFULENBQXFCLG1CQUFyQixFQURMOztZQURnQixDQUFwQjttQkFHQSxLQUFDLENBQUEsT0FBTyxDQUFDLEdBQVQsQ0FBYSxLQUFiO1VBOUVPO1FBQUEsQ0FBQSxDQUFBLENBQUEsSUFBQSxDQUFYO0FBK0VBLGVBQU87TUFoS0QsQ0FqQlY7O0VBRGE7QUFBakIiLCJzb3VyY2VzQ29udGVudCI6WyIjIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiMgIENvbG9yIFBpY2tlci9leHRlbnNpb25zOiBDb2xvclxuIyAgVGhlIGVsZW1lbnQgc2hvd2luZyB0aGUgY3VycmVudCBjb2xvclxuIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG5cbiAgICBtb2R1bGUuZXhwb3J0cyA9IChjb2xvclBpY2tlcikgLT5cbiAgICAgICAgRW1pdHRlcjogKHJlcXVpcmUgJy4uL21vZHVsZXMvRW1pdHRlcicpKClcblxuICAgICAgICBlbGVtZW50OiBudWxsXG4gICAgICAgIGNvbG9yOiBudWxsXG5cbiAgICAjIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgICAjICBTZXQgdXAgZXZlbnRzIGFuZCBoYW5kbGluZ1xuICAgICMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAgICAgICAjIE91dHB1dCBmb3JtYXQgZXZlbnRcbiAgICAgICAgZW1pdE91dHB1dEZvcm1hdDogKGZvcm1hdCkgLT5cbiAgICAgICAgICAgIEBFbWl0dGVyLmVtaXQgJ291dHB1dEZvcm1hdCcsIGZvcm1hdFxuICAgICAgICBvbk91dHB1dEZvcm1hdDogKGNhbGxiYWNrKSAtPlxuICAgICAgICAgICAgQEVtaXR0ZXIub24gJ291dHB1dEZvcm1hdCcsIGNhbGxiYWNrXG5cbiAgICAjIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgICAjICBDcmVhdGUgYW5kIGFjdGl2YXRlIENvbG9yIGVsZW1lbnRcbiAgICAjIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgICAgICAgYWN0aXZhdGU6IC0+XG4gICAgICAgICAgICBAZWxlbWVudCA9XG4gICAgICAgICAgICAgICAgZWw6IGRvIC0+XG4gICAgICAgICAgICAgICAgICAgIF9jbGFzc1ByZWZpeCA9IGNvbG9yUGlja2VyLmVsZW1lbnQuZWwuY2xhc3NOYW1lXG4gICAgICAgICAgICAgICAgICAgIF9lbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQgJ2RpdidcbiAgICAgICAgICAgICAgICAgICAgX2VsLmNsYXNzTGlzdC5hZGQgXCIjeyBfY2xhc3NQcmVmaXggfS1jb2xvclwiXG5cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9lbFxuICAgICAgICAgICAgICAgICMgVXRpbGl0eSBmdW5jdGlvbnNcbiAgICAgICAgICAgICAgICBhZGRDbGFzczogKGNsYXNzTmFtZSkgLT4gQGVsLmNsYXNzTGlzdC5hZGQgY2xhc3NOYW1lOyByZXR1cm4gdGhpc1xuICAgICAgICAgICAgICAgIHJlbW92ZUNsYXNzOiAoY2xhc3NOYW1lKSAtPiBAZWwuY2xhc3NMaXN0LnJlbW92ZSBjbGFzc05hbWU7IHJldHVybiB0aGlzXG5cbiAgICAgICAgICAgICAgICBoZWlnaHQ6IC0+IEBlbC5vZmZzZXRIZWlnaHRcblxuICAgICAgICAgICAgICAgICMgQWRkIGEgY2hpbGQgb24gdGhlIENvbG9yIGVsZW1lbnRcbiAgICAgICAgICAgICAgICBhZGQ6IChlbGVtZW50KSAtPlxuICAgICAgICAgICAgICAgICAgICBAZWwuYXBwZW5kQ2hpbGQgZWxlbWVudFxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpc1xuXG4gICAgICAgICAgICAgICAgIyBTZXQgdGhlIENvbG9yIGVsZW1lbnQgYmFja2dyb3VuZCBjb2xvclxuICAgICAgICAgICAgICAgIHByZXZpb3VzQ29sb3I6IG51bGxcbiAgICAgICAgICAgICAgICBzZXRDb2xvcjogKHNtYXJ0Q29sb3IpIC0+XG4gICAgICAgICAgICAgICAgICAgIF9jb2xvciA9IHNtYXJ0Q29sb3IudG9SR0JBKClcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGlmIEBwcmV2aW91c0NvbG9yIGFuZCBAcHJldmlvdXNDb2xvciBpcyBfY29sb3JcbiAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIEBlbC5zdHlsZS5iYWNrZ3JvdW5kQ29sb3IgPSBfY29sb3JcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEBwcmV2aW91c0NvbG9yID0gX2NvbG9yXG4gICAgICAgICAgICBjb2xvclBpY2tlci5lbGVtZW50LmFkZCBAZWxlbWVudC5lbFxuXG4gICAgICAgICMgIEluY3JlYXNlIENvbG9yIFBpY2tlciBoZWlnaHRcbiAgICAgICAgIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgICAgICAgICAgIHNldFRpbWVvdXQgPT5cbiAgICAgICAgICAgICAgICBfbmV3SGVpZ2h0ID0gY29sb3JQaWNrZXIuZWxlbWVudC5oZWlnaHQoKSArIEBlbGVtZW50LmhlaWdodCgpXG4gICAgICAgICAgICAgICAgY29sb3JQaWNrZXIuZWxlbWVudC5zZXRIZWlnaHQgX25ld0hlaWdodFxuXG4gICAgICAgICMgIFNldCBvciByZXBsYWNlIENvbG9yIG9uIGNsaWNrXG4gICAgICAgICMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgICAgICAgICBoYXNDaGlsZCA9IChlbGVtZW50LCBjaGlsZCkgLT5cbiAgICAgICAgICAgICAgICBpZiBjaGlsZCBhbmQgX3BhcmVudCA9IGNoaWxkLnBhcmVudE5vZGVcbiAgICAgICAgICAgICAgICAgICAgaWYgY2hpbGQgaXMgZWxlbWVudFxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWVcbiAgICAgICAgICAgICAgICAgICAgZWxzZSByZXR1cm4gaGFzQ2hpbGQgZWxlbWVudCwgX3BhcmVudFxuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZVxuXG4gICAgICAgICAgICBfaXNDbGlja2luZyA9IG5vXG5cbiAgICAgICAgICAgIGNvbG9yUGlja2VyLm9uTW91c2VEb3duIChlLCBpc09uUGlja2VyKSA9PlxuICAgICAgICAgICAgICAgIHJldHVybiB1bmxlc3MgaXNPblBpY2tlciBhbmQgaGFzQ2hpbGQgQGVsZW1lbnQuZWwsIGUudGFyZ2V0XG4gICAgICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpXG4gICAgICAgICAgICAgICAgX2lzQ2xpY2tpbmcgPSB5ZXNcblxuICAgICAgICAgICAgY29sb3JQaWNrZXIub25Nb3VzZU1vdmUgKGUpIC0+XG4gICAgICAgICAgICAgICAgX2lzQ2xpY2tpbmcgPSBub1xuXG4gICAgICAgICAgICBjb2xvclBpY2tlci5vbk1vdXNlVXAgKGUpID0+XG4gICAgICAgICAgICAgICAgcmV0dXJuIHVubGVzcyBfaXNDbGlja2luZ1xuICAgICAgICAgICAgICAgIGNvbG9yUGlja2VyLnJlcGxhY2UgQGNvbG9yXG4gICAgICAgICAgICAgICAgY29sb3JQaWNrZXIuZWxlbWVudC5jbG9zZSgpXG5cbiAgICAgICAgIyAgU2V0IG9yIHJlcGxhY2UgQ29sb3Igb24ga2V5IHByZXNzIGVudGVyXG4gICAgICAgICMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgICAgICAgICBjb2xvclBpY2tlci5vbktleURvd24gKGUpID0+XG4gICAgICAgICAgICAgICAgcmV0dXJuIHVubGVzcyBlLndoaWNoIGlzIDEzXG4gICAgICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKVxuICAgICAgICAgICAgICAgIGNvbG9yUGlja2VyLnJlcGxhY2UgQGNvbG9yXG5cbiAgICAgICAgIyAgU2V0IGJhY2tncm91bmQgZWxlbWVudCBjb2xvciBvbiBBbHBoYSBjaGFuZ2VcbiAgICAgICAgIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgICAgICAgICAgIHNldFRpbWVvdXQgPT4gIyB3YWl0IGZvciB0aGUgRE9NXG4gICAgICAgICAgICAgICAgQWxwaGEgPSBjb2xvclBpY2tlci5nZXRFeHRlbnNpb24gJ0FscGhhJ1xuXG4gICAgICAgICAgICAgICAgQWxwaGEub25Db2xvckNoYW5nZWQgKHNtYXJ0Q29sb3IpID0+XG4gICAgICAgICAgICAgICAgICAgIEBlbGVtZW50LnNldENvbG9yIGRvIC0+XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiBzbWFydENvbG9yIHRoZW4gcmV0dXJuIHNtYXJ0Q29sb3JcbiAgICAgICAgICAgICAgICAgICAgICAgICMgRGVmYXVsdCB0byAjZjAwIHJlZFxuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSByZXR1cm4gY29sb3JQaWNrZXIuU21hcnRDb2xvci5IRVggJyNmMDAnXG4gICAgICAgICAgICAgICAgICAgIHJldHVyblxuICAgICAgICAgICAgICAgIHJldHVyblxuXG4gICAgICAgICMgIENyZWF0ZSBDb2xvciB0ZXh0IGVsZW1lbnRcbiAgICAgICAgIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgICAgICAgICAgIHNldFRpbWVvdXQgPT5cbiAgICAgICAgICAgICAgICBBbHBoYSA9IGNvbG9yUGlja2VyLmdldEV4dGVuc2lvbiAnQWxwaGEnXG4gICAgICAgICAgICAgICAgUmV0dXJuID0gY29sb3JQaWNrZXIuZ2V0RXh0ZW5zaW9uICdSZXR1cm4nXG4gICAgICAgICAgICAgICAgRm9ybWF0ID0gY29sb3JQaWNrZXIuZ2V0RXh0ZW5zaW9uICdGb3JtYXQnXG5cbiAgICAgICAgICAgICAgICAjIENyZWF0ZSB0ZXh0IGVsZW1lbnRcbiAgICAgICAgICAgICAgICBfdGV4dCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQgJ3AnXG4gICAgICAgICAgICAgICAgX3RleHQuY2xhc3NMaXN0LmFkZCBcIiN7IEBlbGVtZW50LmVsLmNsYXNzTmFtZSB9LXRleHRcIlxuXG4gICAgICAgICAgICAgICAgIyBSZXNldCBiZWZvcmUgY29sb3IgcGlja2VyIG9wZW5cbiAgICAgICAgICAgICAgICBjb2xvclBpY2tlci5vbkJlZm9yZU9wZW4gPT4gQGNvbG9yID0gbnVsbFxuXG4gICAgICAgICAgICAgICAgIyBLZWVwIHRyYWNrIG9mIHRoZSBpbnB1dCBjb2xvciAoZm9yIGl0cyBmb3JtYXQpXG4gICAgICAgICAgICAgICAgX2lucHV0Q29sb3IgPSBudWxsXG5cbiAgICAgICAgICAgICAgICBjb2xvclBpY2tlci5vbklucHV0Q29sb3IgKHNtYXJ0Q29sb3IsIHdhc0ZvdW5kKSAtPlxuICAgICAgICAgICAgICAgICAgICBfaW5wdXRDb2xvciA9IGlmIHdhc0ZvdW5kXG4gICAgICAgICAgICAgICAgICAgICAgICBzbWFydENvbG9yXG4gICAgICAgICAgICAgICAgICAgIGVsc2UgbnVsbFxuXG4gICAgICAgICAgICAgICAgIyBLZWVwIHRyYWNrIG9mIHRoZSBGb3JtYXQgZWxlbWVudCBmb3JtYXRcbiAgICAgICAgICAgICAgICBfZm9ybWF0Rm9ybWF0ID0gbnVsbFxuICAgICAgICAgICAgICAgIEZvcm1hdC5vbkZvcm1hdENoYW5nZWQgKGZvcm1hdCkgLT4gX2Zvcm1hdEZvcm1hdCA9IGZvcm1hdFxuICAgICAgICAgICAgICAgIGNvbG9yUGlja2VyLm9uSW5wdXRDb2xvciAtPiBfZm9ybWF0Rm9ybWF0ID0gbnVsbFxuXG4gICAgICAgICAgICAgICAgIyBTZXQgdGhlIHRleHQgZWxlbWVudCB0byBjb250YWluIHRoZSBDb2xvciBkYXRhXG4gICAgICAgICAgICAgICAgc2V0Q29sb3IgPSAoc21hcnRDb2xvcikgPT5cbiAgICAgICAgICAgICAgICAgICAgX3ByZWZlcnJlZEZvcm1hdCA9IGF0b20uY29uZmlnLmdldCAnY29sb3ItcGlja2VyLnByZWZlcnJlZEZvcm1hdCdcbiAgICAgICAgICAgICAgICAgICAgX2Zvcm1hdCA9IF9mb3JtYXRGb3JtYXQgb3IgX2lucHV0Q29sb3I/LmZvcm1hdCBvciBfcHJlZmVycmVkRm9ybWF0IG9yICdSR0InXG5cbiAgICAgICAgICAgICAgICAgICAgIyBUT0RPOiBUaGlzIGlzIHZlcnkgZnJhZ2lsZVxuICAgICAgICAgICAgICAgICAgICBfZnVuY3Rpb24gPSBpZiBzbWFydENvbG9yLmdldEFscGhhKCkgPCAxXG4gICAgICAgICAgICAgICAgICAgICAgICAoc21hcnRDb2xvcltcInRvI3sgX2Zvcm1hdCB9QVwiXSBvciBzbWFydENvbG9yW1widG8jeyBfZm9ybWF0IH1cIl0pXG4gICAgICAgICAgICAgICAgICAgIGVsc2Ugc21hcnRDb2xvcltcInRvI3sgX2Zvcm1hdCB9XCJdXG5cbiAgICAgICAgICAgICAgICAgICAgIyBJZiBhIGNvbG9yIHdhcyBpbnB1dCwgYW5kIHRoZSB2YWx1ZSBoYXNuJ3QgY2hhbmdlZCBzaW5jZSxcbiAgICAgICAgICAgICAgICAgICAgIyBzaG93IHRoZSBpbml0YWwgdmFsdWUgbm90IHRvIGNvbmZ1c2UgdGhlIHVzZXIsIGJ1dCBvbmx5XG4gICAgICAgICAgICAgICAgICAgICMgaWYgdGhlIGlucHV0IGNvbG9yIGZvcm1hdCBpcyBzdGlsbCB0aGUgc2FtZVxuICAgICAgICAgICAgICAgICAgICBfb3V0cHV0Q29sb3IgPSBkbyAtPlxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgX2lucHV0Q29sb3IgYW5kIChfaW5wdXRDb2xvci5mb3JtYXQgaXMgX2Zvcm1hdCBvciBfaW5wdXRDb2xvci5mb3JtYXQgaXMgXCIjeyBfZm9ybWF0IH1BXCIpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgc21hcnRDb2xvci5lcXVhbHMgX2lucHV0Q29sb3JcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9pbnB1dENvbG9yLnZhbHVlXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gX2Z1bmN0aW9uLmNhbGwgc21hcnRDb2xvclxuXG4gICAgICAgICAgICAgICAgICAgICMgRmluaXNoIGhlcmUgaWYgdGhlIF9vdXRwdXRDb2xvciBpcyB0aGUgc2FtZSBhcyB0aGVcbiAgICAgICAgICAgICAgICAgICAgIyBjdXJyZW50IGNvbG9yXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB1bmxlc3MgX291dHB1dENvbG9yIGlzbnQgQGNvbG9yXG5cbiAgICAgICAgICAgICAgICAgICAgIyBBdXRvbWF0aWNhbGx5IHJlcGxhY2UgY29sb3IgaW4gZWRpdG9yIGlmXG4gICAgICAgICAgICAgICAgICAgICMgYGF1dG9tYXRpY1JlcGxhY2VgIGlzIHRydWUsIGJ1dCBvbmx5IGlmIHRoZXJlIHdhcyBhblxuICAgICAgICAgICAgICAgICAgICAjIGlucHV0IGNvbG9yIGFuZCBpZiBpdCBpcyBkaWZmZXJlbnQgZnJvbSBiZWZvcmVcbiAgICAgICAgICAgICAgICAgICAgaWYgX2lucHV0Q29sb3IgYW5kIGF0b20uY29uZmlnLmdldCAnY29sb3ItcGlja2VyLmF1dG9tYXRpY1JlcGxhY2UnXG4gICAgICAgICAgICAgICAgICAgICAgICBjb2xvclBpY2tlci5yZXBsYWNlIF9vdXRwdXRDb2xvclxuXG4gICAgICAgICAgICAgICAgICAgICMgU2V0IGFuZCBzYXZlIHRoZSBvdXRwdXQgY29sb3JcbiAgICAgICAgICAgICAgICAgICAgQGNvbG9yID0gX291dHB1dENvbG9yXG4gICAgICAgICAgICAgICAgICAgIF90ZXh0LmlubmVyVGV4dCA9IF9vdXRwdXRDb2xvclxuXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBAZW1pdE91dHB1dEZvcm1hdCBfZm9ybWF0XG5cbiAgICAgICAgICAgICAgICAjIFVwZGF0ZSBvbiBhbHBoYSBjaGFuZ2UsIGtlZXAgdHJhY2sgb2YgY3VycmVudCBjb2xvclxuICAgICAgICAgICAgICAgIF9jdXJyZW50Q29sb3IgPSBudWxsXG5cbiAgICAgICAgICAgICAgICBBbHBoYS5vbkNvbG9yQ2hhbmdlZCAoc21hcnRDb2xvcikgPT5cbiAgICAgICAgICAgICAgICAgICAgc2V0Q29sb3IgX2N1cnJlbnRDb2xvciA9IGRvIC0+XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiBzbWFydENvbG9yIHRoZW4gcmV0dXJuIHNtYXJ0Q29sb3JcbiAgICAgICAgICAgICAgICAgICAgICAgICMgRGVmYXVsdCB0byAjZjAwIHJlZFxuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSByZXR1cm4gY29sb3JQaWNrZXIuU21hcnRDb2xvci5IRVggJyNmMDAnXG4gICAgICAgICAgICAgICAgICAgIHJldHVyblxuXG4gICAgICAgICAgICAgICAgIyBXaGVuIEZvcm1hdCBpcyBjaGFuZ2VkLCB1cGRhdGUgY29sb3JcbiAgICAgICAgICAgICAgICBGb3JtYXQub25Gb3JtYXRDaGFuZ2VkIC0+IHNldENvbG9yIF9jdXJyZW50Q29sb3JcblxuICAgICAgICAgICAgICAgICMgV2hlbiB0aGUgYFJldHVybmAgZWxlbWVudCBpcyB2aXNpYmxlLCBhZGQgYSBjbGFzcyB0byBhbGxvd1xuICAgICAgICAgICAgICAgICMgdGhlIHRleHQgdG8gYmUgcHVzaGVkIHVwIG9yIGRvd24gYSBiaXRcbiAgICAgICAgICAgICAgICBSZXR1cm4ub25WaXNpYmlsaXR5ICh2aXNpYmlsaXR5KSA9PlxuICAgICAgICAgICAgICAgICAgICBpZiB2aXNpYmlsaXR5IHRoZW4gQGVsZW1lbnQuYWRkQ2xhc3MgJ2lzLS1yZXR1cm5WaXNpYmxlJ1xuICAgICAgICAgICAgICAgICAgICBlbHNlIEBlbGVtZW50LnJlbW92ZUNsYXNzICdpcy0tcmV0dXJuVmlzaWJsZSdcbiAgICAgICAgICAgICAgICBAZWxlbWVudC5hZGQgX3RleHRcbiAgICAgICAgICAgIHJldHVybiB0aGlzXG4iXX0=
